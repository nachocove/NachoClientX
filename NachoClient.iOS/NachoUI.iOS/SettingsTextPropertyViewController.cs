// This file has been autogenerated from a class added in the UI designer.

using System;
using CoreGraphics;
using Foundation;
using UIKit;
using System.Collections.Generic;
using System.IO;
using NachoCore.Utils;

namespace NachoClient.iOS
{
    public partial class SettingsTextPropertyViewController : NcUIViewControllerNoLeaks
    {
        public SettingsTextPropertyViewController ()
            : base ()
        {
        }

        public delegate void OnSaveCallback (string text);

        string itemTitle;

        string plainExplanation;
        string existingPlain;
        OnSaveCallback OnSavePlain;

        UILabel plainExplanationView;
        NcTextView plainTextView;
        UIBarButtonItem saveButton;
        UIBarButtonItem cancelButton;

        private static nfloat HORIZONTAL_MARGIN = 15f;
        private static nfloat VERTICAL_MARGIN = 15f;

        public void Setup (string title, string explanatoryText, string existingText, OnSaveCallback onSave)
        {
            this.itemTitle = title;
            this.plainExplanation = explanatoryText;
            this.existingPlain = existingText;
            this.OnSavePlain = onSave;
        }

        protected override void CreateViewHierarchy ()
        {
            View.BackgroundColor = UIColor.White;

            cancelButton = new NcUIBarButtonItem ();
            Util.SetAutomaticImageForButton (cancelButton, "icn-close");
            cancelButton.AccessibilityLabel = "Close";
            cancelButton.Clicked += CancelButton_Clicked;

            saveButton = new NcUIBarButtonItem ();
            saveButton.Title = "Save";
            saveButton.AccessibilityLabel = "Send";
            saveButton.Clicked += SaveButton_Clicked;

            NavigationItem.LeftBarButtonItem = cancelButton;
            NavigationItem.RightBarButtonItem = saveButton;

            plainExplanationView = new UILabel (new CGRect (0, 0, View.Frame.Width, 0));
            plainExplanationView.Font = A.Font_AvenirNextRegular14;
            plainExplanationView.TextColor = UIColor.Black;
            plainExplanationView.TextAlignment = UITextAlignment.Center;
            plainExplanationView.BackgroundColor = A.Color_NachoLightGrayBackground;
            plainExplanationView.LineBreakMode = UILineBreakMode.WordWrap;
            View.AddSubview (plainExplanationView);

            plainTextView = new NcTextView (new CGRect (HORIZONTAL_MARGIN, 0, View.Frame.Width - (2 * HORIZONTAL_MARGIN), View.Frame.Height));
            plainTextView.Font = A.Font_AvenirNextRegular14;
            plainTextView.TextColor = A.Color_NachoBlack;
            plainTextView.BackgroundColor = UIColor.White;
            plainTextView.ContentInset = new UIEdgeInsets (VERTICAL_MARGIN, 0, VERTICAL_MARGIN, 0);
            plainTextView.SelectionChanged += SelectionChangedHandler;
            View.AddSubview (plainTextView);
        }

        void SaveButton_Clicked (object sender, EventArgs e)
        {
            if (null != OnSavePlain) {
                OnSavePlain (plainTextView.Text);
            }
            NavigationController.PopViewController (true);
        }

        void CancelButton_Clicked (object sender, EventArgs e)
        {
            View.EndEditing (true);
            NavigationController.PopViewController (true);
        }

        protected override void ConfigureAndLayout ()
        {

            if (string.IsNullOrEmpty (plainExplanation)) {
                plainExplanationView.Hidden = true;
                ViewFramer.Create (plainExplanationView).Height (0);
            } else {
                plainExplanationView.Hidden = false;
                plainExplanationView.Lines = 0;
                plainExplanationView.Text = plainExplanation;
                plainExplanationView.SizeToFit ();
                ViewFramer.Create (plainExplanationView).AdjustHeight (20).Width (View.Frame.Width);
            }

            plainTextView.Hidden = false;
            plainTextView.Text = existingPlain;
            plainTextView.SelectedRange = new NSRange (0, 0);
            plainTextView.BecomeFirstResponder ();


            Layout ();
        }

        protected override void Cleanup ()
        {
            plainTextView.SelectionChanged -= SelectionChangedHandler;
            plainTextView = null;
        }

        protected override void OnKeyboardChanged ()
        {
            Layout ();
            MakeCaretVisible (false);
        }

        private void Layout ()
        {
            var yOffset = plainExplanationView.Frame.Bottom;
            ViewFramer.Create (plainTextView).Y (yOffset).Height (View.Frame.Height - yOffset - keyboardHeight);
        }

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();
            NavigationItem.Title = itemTitle;
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            if (null != this.NavigationController) {
                this.NavigationController.ToolbarHidden = true;
            }
        }

        public override void ViewDidAppear (bool animated)
        {
            base.ViewDidAppear (animated);
            if (this.NavigationController.RespondsToSelector (new ObjCRuntime.Selector ("interactivePopGestureRecognizer"))) {
                this.NavigationController.InteractivePopGestureRecognizer.Enabled = false;
                this.NavigationController.InteractivePopGestureRecognizer.Delegate = null;
            }
        }

        public override bool HidesBottomBarWhenPushed {
            get {
                return this.NavigationController.TopViewController == this;
            }
        }

        private void MakeCaretVisible (bool animated)
        {
            var caretFrame = plainTextView.GetCaretRectForPosition (plainTextView.SelectedTextRange.End);
            plainTextView.ScrollRectToVisible (caretFrame, animated);
        }

        private void SelectionChangedHandler (object sender, EventArgs args)
        {
            MakeCaretVisible (true);
        }
    }
}
