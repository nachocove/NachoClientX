// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using Foundation;
using UIKit;
using NachoCore.Model;
using NachoCore.Utils;
using NachoCore.Brain;
using CoreAnimation;
using CoreGraphics;

namespace NachoClient.iOS
{

    #region Delegate

    public interface AccountTypeViewControllerDelegate
    {

        void AccountTypeViewControllerDidSelectService (AccountTypeViewController vc, McAccount.AccountServiceEnum service);

    }

    #endregion

    public partial class AccountTypeViewController : UICollectionViewController, ThemeAdopter, ExchangeEnableViewDelegate
    {

        #region Properties

        public AccountTypeViewControllerDelegate AccountDelegate;

        private static NSString AccountTypeCellIdentifier = (NSString)"Account";

        protected static McAccount.AccountServiceEnum[] DefaultAccountTypes = new McAccount.AccountServiceEnum[] {
            McAccount.AccountServiceEnum.Exchange,
            McAccount.AccountServiceEnum.GoogleDefault,
            McAccount.AccountServiceEnum.GoogleExchange,
            McAccount.AccountServiceEnum.HotmailExchange,
            McAccount.AccountServiceEnum.iCloud,
            McAccount.AccountServiceEnum.IMAP_SMTP,
            McAccount.AccountServiceEnum.Office365Exchange,
            McAccount.AccountServiceEnum.OutlookExchange,
            McAccount.AccountServiceEnum.Yahoo,
        };

        private McAccount.AccountServiceEnum[] accountTypes;

        #endregion

        #region Constructors

        public AccountTypeViewController (IntPtr handle) : base (handle)
        {
            NavigationItem.BackBarButtonItem = new UIBarButtonItem ();
            NavigationItem.BackBarButtonItem.Title = "";
            accountTypes = DefaultAccountTypes;
        }

        #endregion

        #region Theme

        Theme adoptedTheme;

        public void AdoptTheme (Theme theme)
        {
            if (theme != adoptedTheme) {
                adoptedTheme = theme;
                CollectionView.BackgroundColor = View.BackgroundColor = theme.AccountCreationBackgroundColor;
                if (CollectionView.VisibleCells != null) {
                    foreach (var cell in CollectionView.VisibleCells) {
                        var themedCell = (cell as ThemeAdopter);
                        if (themedCell != null) {
                            themedCell.AdoptTheme (theme);
                        }
                    }
                }
            }
        }

        #endregion

        #region View Lifecycle

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            AdoptTheme (Theme.Active);
        }

        public override void ViewDidAppear (bool animated)
        {
            base.ViewDidAppear (animated);
            BecomeFirstResponder ();
        }

        public override bool CanBecomeFirstResponder {
            get {
                return true;
            }
        }

        #endregion

        #region Collection View Delegate & Data Source

        public override nint NumberOfSections (UICollectionView collectionView)
        {
            return 1;
        }

        public override nint GetItemsCount (UICollectionView collectionView, nint section)
        {
            return accountTypes.Length;
        }

        public override UICollectionViewCell GetCell (UICollectionView collectionView, NSIndexPath indexPath)
        {
            var cell = (NcAccountTypeCollectionViewCell)collectionView.DequeueReusableCell (AccountTypeCellIdentifier, indexPath);
            var accountType = accountTypes [indexPath.Item];
            var imageName = Util.GetAccountServiceImageName (accountType);
            using (var image = UIImage.FromBundle (imageName)) {
                cell.iconView.Image = image;
            }
            cell.label.Text = NcServiceHelper.AccountServiceName (accountType);
            cell.AccessibilityLabel = cell.label.Text;
            if (adoptedTheme != null) {
                cell.AdoptTheme (adoptedTheme);
            }
            return cell;
        }

        public override void ItemHighlighted (UICollectionView collectionView, NSIndexPath indexPath)
        {
            var cell = (NcAccountTypeCollectionViewCell)collectionView.CellForItem (indexPath);
            cell.iconView.Alpha = 0.5f;
        }

        public override void ItemUnhighlighted (UICollectionView collectionView, NSIndexPath indexPath)
        {
            var cell = (NcAccountTypeCollectionViewCell)collectionView.CellForItem (indexPath);
            cell.iconView.Alpha = 1.0f;
        }

        public override void ItemSelected (UICollectionView collectionView, NSIndexPath indexPath)
        {
            if (AccountDelegate != null) {
                var accountType = accountTypes [indexPath.Item];
                var generalAccountType = McAccount.GetAccountType (accountType);
                if (generalAccountType == McAccount.AccountTypeEnum.Exchange && !NachoCore.Utils.PermissionManager.Instance.CanCreateExchange) {
                    var viewController = new ExchangeEnableViewController (accountType);
                    viewController.Delegate = this;
                    PresentViewController (viewController, true, null);
                } else {
                    Log.Info (Log.LOG_UI, "AccountTypeViewController selected {0}", accountType);
                    AccountDelegate.AccountTypeViewControllerDidSelectService (this, accountType);
                }
            }
        }

        public void ExchangeEnableViewDidComplete (ExchangeEnableViewController vc, bool exchangeEnabled)
        {
            if (exchangeEnabled){
                var accountType = vc.Service;
                Log.Info (Log.LOG_UI, "AccountTypeViewController selected after exchange enabled {0}", accountType);
                AccountDelegate.AccountTypeViewControllerDidSelectService (this, accountType);
            }
            vc.DismissViewController (animated: true, completionHandler: null);
        }

        #endregion

        #region Events

        public override void MotionEnded (UIEventSubtype motion, UIEvent evt)
        {
            if (motion == UIEventSubtype.MotionShake) {
                if (NachoClient.Build.BuildInfo.Version.StartsWith ("DEV[", StringComparison.Ordinal) && NachoCore.Utils.PermissionManager.Instance.CanCreateExchange){
                    var alert = UIAlertController.Create ("Reset Exchange Access", "Disable exchange account creation", UIAlertControllerStyle.Alert);
                    alert.AddAction (UIAlertAction.Create ("Cancel", UIAlertActionStyle.Cancel,(obj) => {}));
                    alert.AddAction (UIAlertAction.Create ("OK", UIAlertActionStyle.Destructive, (obj) => {
                        NachoCore.Utils.PermissionManager.Instance.ResetCanCreateExchange ();
                    }));
                    PresentViewController (alert, animated: true, completionHandler: null);
                }
            } else {
                base.MotionEnded (motion, evt);
            }
        }

        #endregion

        #region Public Helpers

        public AccountCredentialsViewController SuggestedCredentialsViewController (McAccount.AccountServiceEnum service)
        {
            if (service == McAccount.AccountServiceEnum.GoogleDefault) {
                Log.Info (Log.LOG_UI, "GettingStartedViewController need google credentials");
                return (GoogleCredentialsViewController)Storyboard.InstantiateViewController ("GoogleCredentialsViewController");
            } else if (service == McAccount.AccountServiceEnum.SalesForce) {
                Log.Info (Log.LOG_UI, "GettingStartedViewController need salesforce credentials");
                return (SalesforceCredentialsViewController)Storyboard.InstantiateViewController ("SalesforceCredentialsViewController");
            } else {
                Log.Info (Log.LOG_UI, "GettingStartedViewController prompting for credentials for {0}", service);
                return (AccountCredentialsViewController)Storyboard.InstantiateViewController ("AccountCredentialsViewController");
            }
        }

        #endregion

    }

}
