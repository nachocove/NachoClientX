// This file has been autogenerated from a class added in the UI designer.

using System;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using NachoCore.Model;
using MonoTouch.Dialog;
using NachoCore.ActiveSync;

namespace NachoClient.iOS
{
    public partial class ContactViewController : DialogViewController
    {
        public bool editing;
        public McContact contact;
        UIBarButtonItem doneButton;
        UIBarButtonItem editButton;

        public ContactViewController (IntPtr handle) : base (handle)
        {
            doneButton = new UIBarButtonItem (UIBarButtonSystemItem.Done);
            editButton = new UIBarButtonItem (UIBarButtonSystemItem.Edit);
        }

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();

            // When user clicks done, check, confirm, and save
            doneButton.Clicked += (object sender, EventArgs e) => {
                // TODO: Check for changes before asking the user
                UIAlertView alert = new UIAlertView();
                alert.Title = "Confirmation";
                alert.Message = "Save this contact?";
                alert.AddButton("Yes");
                alert.AddButton("No");
                alert.Dismissed += (object alertSender, UIButtonEventArgs alertEvent) => {
                    if(0 == alertEvent.ButtonIndex) {
                        editing = false;
                        // TODO: Save the new
                        NavigationItem.RightBarButtonItem = editButton;
                        Root = ToDialogElement (contact);
                        ReloadComplete ();
                    }
                };
                alert.Show();
            };

            editButton.Clicked += (object sender, EventArgs e) => {
                editing = true;
                NavigationItem.RightBarButtonItem = doneButton;
                Root = ToDialogElement (contact);
                ReloadComplete ();
            };

            // Set up view
            Pushing = true;
            if (null == contact) {
                editing = true;
                contact = new McContact ();
                Root = ToDialogElement (contact);
                NavigationItem.RightBarButtonItem = doneButton;
            } else {
                editing = false;
                Root = ToDialogElement (contact);
                NavigationItem.RightBarButtonItem = editButton;
            }
        }

        public void AddIfSet (ref Section section, string name, string value, UIKeyboardType kbt = UIKeyboardType.Default)
        {
            if (editing) {
                EntryElement e = new EntryElement (name, "", value ?? "");
                e.KeyboardType = kbt;
                section.Add (e);
            } else if (null != value) {
                section.Add (new StringElement (name, value));
            }
        }

        public void AddIfSet (ref Section section, string name, DateTime value)
        {
            if (!McContact.IsNull (value)) {
                section.Add (new DateElement (name, value));
            }
        }

        public void AddIfSet (ref Section section, string name, int value)
        {
            if (!McContact.IsNull (value)) {
                section.Add (new StringElement (name, value.ToString ()));
            }
        }

        public RootElement ToDialogElement (McContact m)
        {
            System.Diagnostics.Trace.Assert (null != m);

            var root = new RootElement (m.DisplayName);
            var section = new Section ();

            var r = AsContact.FromMcContact (m);
            var c = (AsContact)r.GetObject ();

            // Person
            AddIfSet (ref section, "Title", c.Title);
            AddIfSet (ref section, "First name", c.FirstName);
            AddIfSet (ref section, "Middle name", c.MiddleName);
            AddIfSet (ref section, "Last name", c.LastName);
            AddIfSet (ref section, "Suffix", c.Suffix);
            AddIfSet (ref section, "Nickname", c.NickName);
            AddIfSet (ref section, "Job title", c.JobTitle);

            AddIfSet (ref section, "Alias", c.Alias);
            AddIfSet (ref section, "File As", c.FileAs);
            AddIfSet (ref section, "Account Name", c.AccountName);
            AddIfSet (ref section, "Customer Id", c.CustomerId);
            AddIfSet (ref section, "Government Id", c.GovernmentId);

            // Business Phone number stuff



            AddIfSet (ref section, "Business phone number", c.BusinessPhoneNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "Business phone number", c.Business2PhoneNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "Business fax number", c.BusinessFaxNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "Mobile phone number", c.MobilePhoneNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "Radio phone number", c.RadioPhoneNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "Pager number", c.PagerNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "MMS number", c.MMS, UIKeyboardType.NumbersAndPunctuation);

            // Email addresses
            AddIfSet (ref section, "Email", c.Email1Address, UIKeyboardType.EmailAddress);
            AddIfSet (ref section, "Email", c.Email2Address, UIKeyboardType.EmailAddress);
            AddIfSet (ref section, "Email", c.Email3Address, UIKeyboardType.EmailAddress);

            // IM
            AddIfSet (ref section, "IM Address", c.IMAddress);
            AddIfSet (ref section, "IM Address", c.IMAddress2);
            AddIfSet (ref section, "IM Address", c.IMAddress3);

            AddIfSet (ref section, "Web page", c.WebPage, UIKeyboardType.Url);

            // Others at work
            AddIfSet (ref section, "Manager name", c.ManagerName);
            AddIfSet (ref section, "Assistant name", c.AssistantName);
            AddIfSet (ref section, "Assistant phone number", c.AssistantPhoneNumber, UIKeyboardType.NumbersAndPunctuation);

            // Company stuff
            AddIfSet (ref section, "Company name", c.CompanyName);
            AddIfSet (ref section, "Department name", c.Department);
            AddIfSet (ref section, "Office location", c.OfficeLocation);
            AddIfSet (ref section, "Company phone number", c.CompanyMainPhone, UIKeyboardType.NumbersAndPunctuation);

            // Home stuff
            AddIfSet (ref section, "Home phone number", c.HomePhoneNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "Home phone number", c.Home2PhoneNumber, UIKeyboardType.NumbersAndPunctuation);
            AddIfSet (ref section, "Home fax number", c.HomeFaxNumber, UIKeyboardType.NumbersAndPunctuation);

            // Personal
            AddIfSet (ref section, "Birthday", c.Birthday);
            AddIfSet (ref section, "Spouse", c.Spouse);
            AddIfSet (ref section, "Anniversary", c.Anniversary);

            // Weighted rank is inside baseball
            AddIfSet (ref section, "Weighted rank", c.WeightedRank);

            // End section
            root.Add (section);

            // New section for business address
            Section businessAddress = new Section ("Business Address");
            AddIfSet (ref businessAddress, "Street", c.BusinessAddressStreet);
            AddIfSet (ref businessAddress, "City", c.BusinessAddressCity);
            AddIfSet (ref businessAddress, "State", c.BusinessAddressState);
            AddIfSet (ref businessAddress, "Country", c.BusinessAddressCountry);
            AddIfSet (ref businessAddress, "Postal code", c.BusinessAddressPostalCode);
            if (businessAddress.Count > 0) {
                root.Add (businessAddress);
            }

            Section homeAddress = new Section ("Home Address");
            AddIfSet (ref homeAddress, "Street", c.HomeAddressStreet);
            AddIfSet (ref homeAddress, "City", c.HomeAddressCity);
            AddIfSet (ref homeAddress, "State", c.HomeAddressState);
            AddIfSet (ref homeAddress, "Country", c.HomeAddressCountry);
            AddIfSet (ref homeAddress, "Postal code", c.HomeAddressPostalCode);
            if (homeAddress.Count > 0) {
                root.Add (homeAddress);
            }

            Section otherAddress = new Section ("Other Address");
            AddIfSet (ref otherAddress, "Street", c.OtherAddressStreet);
            AddIfSet (ref otherAddress, "City", c.OtherAddressCity);
            AddIfSet (ref otherAddress, "State", c.OtherAddressState);
            AddIfSet (ref otherAddress, "Country", c.OtherAddressCountry);
            AddIfSet (ref otherAddress, "Postal code", c.OtherAddressPostalCode);
            if (otherAddress.Count > 0) {
                root.Add (otherAddress);
            }

            // Unhandled
//            public List<NcContactCategory> categories;
//            public string Children { get; set; }
//            public string Picture { get; set; }
//            public string WebPage { get; set; }
//            public string YomiFirstName { get; set; }
//            public string YomiLastName { get; set; }
//            public string YomiCompanyName { get; set; }

            return root;
        }
    }
}
