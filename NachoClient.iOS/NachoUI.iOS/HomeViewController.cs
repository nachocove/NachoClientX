// This file has been autogenerated from a class added in the UI designer.

using System;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using NachoCore.Model;
using NachoCore.Utils;
using NachoCore;
using SWRevealViewControllerBinding;

namespace NachoClient.iOS
{
    public partial class HomeViewController : NcUIViewController
    {
        UIPageViewController pageController;
        bool hasSyncCompleted = false;
        UILabel autoDState;

        public HomeViewController (IntPtr handle) : base (handle)
        {
        }

        /// <summary>
        /// On first run, push the modal LaunchViewController to get credentials.
        /// </summary>
        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();
            setSyncBit ();
            // Navigation
            revealButton.Action = new MonoTouch.ObjCRuntime.Selector ("revealToggle:");
            revealButton.Target = this.RevealViewController ();

            // Multiple buttons on the left side
            NavigationItem.LeftBarButtonItems = new UIBarButtonItem[] { revealButton, nachoButton };
            using (var nachoImage = UIImage.FromBundle ("Nacho-Cove-Icon")) {
                nachoButton.Image = nachoImage.ImageWithRenderingMode (UIImageRenderingMode.AlwaysOriginal);
            }
            nachoButton.Clicked += (object sender, EventArgs e) => {
                PerformSegue ("HomeToNachoNow", this);
            };

            // Help & demo pages
            InitializePageViewController ();
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            if (null != this.NavigationController) {
                this.NavigationController.ToolbarHidden = true;
            }

            NcApplication.Instance.StatusIndEvent += StatusIndicatorCallback;
        }

        public override void ViewWillDisappear (bool animated)
        {
            base.ViewWillDisappear (animated);
            if (null != this.NavigationController) {
                this.NavigationController.ToolbarHidden = true;
            }
            NcApplication.Instance.StatusIndEvent -= StatusIndicatorCallback;
        }

        public void StatusIndicatorCallback (object sender, EventArgs e)
        {
            var s = (StatusIndEventArgs)e;

            if (NcResult.SubKindEnum.Info_FolderSyncSucceeded == s.Status.SubKind) {
                autoDState.Text = "FolderSyncSucceeded";
                autoDState.TextColor = UIColor.Green;
                folderSyncSuccesful ();
            }
            if (NcResult.SubKindEnum.Info_AsAutoDComplete == s.Status.SubKind) {
                autoDState.Text = "AutoDComplete";
                autoDState.TextColor = UIColor.Yellow;
            }

            if (NcResult.SubKindEnum.Error_NetworkUnavailable == s.Status.SubKind) {
                autoDState.Text = "NetworkUnavailable";
                autoDState.TextColor = UIColor.Red;
            }
        }

        public void InitializePageViewController ()
        {
            // Initialize the first page
            HomePageController firstPageController = new HomePageController (0);

            this.pageController = new UIPageViewController (UIPageViewControllerTransitionStyle.PageCurl, 
                UIPageViewControllerNavigationOrientation.Horizontal, UIPageViewControllerSpineLocation.Min);

            this.pageController.SetViewControllers (new UIViewController[] { firstPageController }, UIPageViewControllerNavigationDirection.Forward, 
                false, s => {
                });

            this.pageController.DataSource = new PageDataSource (this);

            this.pageController.View.Frame = this.View.Bounds;
            this.View.AddSubview (this.pageController.View);

            //Simulates a user dismissing tutorial, or the tutorial finishing on its own
            UIButton closeTutorial = new UIButton (new System.Drawing.RectangleF (20, 400, View.Frame.Width - 40, 50));
            closeTutorial.SetTitle ("Dismiss Tutorial", UIControlState.Normal);
            closeTutorial.TitleLabel.TextColor = UIColor.White;
            closeTutorial.TitleLabel.Font = A.Font_AvenirNextRegular14;
            closeTutorial.BackgroundColor = A.Color_NachoBlue;
            closeTutorial.TouchUpInside += (object sender, EventArgs e) => {
                userViewedTutorial();
                if(hasSyncCompleted){
                    PerformSegue ("HomeToNachoNow", this);
                }else{
                    PerformSegue("HomeToAdvancedLogin", this);
                }
            };
            View.Add (closeTutorial);

            //For testing purposes to see live state of Auto-D
            autoDState = new UILabel (new System.Drawing.RectangleF(20, 460, View.Frame.Width - 40, 30));
            autoDState.Text = "Attempting Auto-D.... ";
            autoDState.TextAlignment = UITextAlignment.Center;
            autoDState.Font = A.Font_AvenirNextDemiBold17;
            autoDState.TextColor = A.Color_NachoRed;
            View.Add (autoDState);
        }

        /// <summary>
        /// Gets the total pages in the "Book".
        /// </summary>
        /// <value>
        /// The total pages in the "Book".
        /// </value>
        public int TotalPages {
            get {
                return 7;
            }
        }
        public void userViewedTutorial()
        {
            //User has view tutorial, set the bit.
            McMutables.GetOrCreate ("TUTORIAL", "hasViewedTutorial", "1");
        }

        public void folderSyncSuccesful()
        {
            //File Sync has been completed, set the bit
            McMutables.Set ("ASYNC", "hasSyncedFolders", "1");
            hasSyncCompleted = true;
        }

        public void setSyncBit()
        {
            string hasSyncedFoldersVal = McMutables.Get ("ASYNC", "hasSyncedFolders");
            if (null != hasSyncedFoldersVal) {
                if (hasSyncedFoldersVal == "1") {
                    hasSyncCompleted = true;
                } else {
                    hasSyncCompleted = false;
                }
            } else {
                hasSyncCompleted = false;
            }
        }

        private class PageDataSource : UIPageViewControllerDataSource
        {
            public PageDataSource (HomeViewController parentController)
            {
                this.parentController = parentController;
            }

            private HomeViewController parentController;

            public override UIViewController GetPreviousViewController (UIPageViewController pageViewController, UIViewController referenceViewController)
            {

                HomePageController currentPageController = referenceViewController as HomePageController;

                // Determine if we are on the first page
                if (currentPageController.PageIndex <= 0) {
                    return null;
                } else {
                    int previousPageIndex = currentPageController.PageIndex - 1;
                    return new HomePageController (previousPageIndex);
                }

            }

            public override UIViewController GetNextViewController (UIPageViewController pageViewController, UIViewController referenceViewController)
            {
                HomePageController currentPageController = referenceViewController as HomePageController;

                // Determine if we are on the last page
                if (currentPageController.PageIndex >= (this.parentController.TotalPages - 1)) {
                    return null;
                } else {
                    int nextPageIndex = currentPageController.PageIndex + 1;
                    return new HomePageController (nextPageIndex);
                }

            }
        }
    }
}
