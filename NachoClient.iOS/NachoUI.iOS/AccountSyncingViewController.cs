// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using UIKit;
using NachoCore.Model;
using NachoCore;
using NachoCore.Utils;
using NachoPlatform;

namespace NachoClient.iOS
{

    public interface AccountSyncingViewControllerDelegate {
        void AccountSyncingViewControllerDidComplete (AccountSyncingViewController vc);
    }

    public partial class AccountSyncingViewController : UIViewController
    {

        public AccountSyncingViewControllerDelegate AccountDelegate;
        private bool StatusIndCallbackIsSet;
        private McAccount account;
        private bool IsSyncingComplete;
        private bool IsVisible;
        private bool DismissOnVisible;
        private NcTimer DismissTimer;

        public McAccount Account {
            get {
                return account;
            }

            set {
                account = value;
                StartListeningForApplicationStatus ();
            }
        }

        public AccountSyncingViewController (IntPtr handle) : base (handle)
        {
            NavigationItem.HidesBackButton = true;
        }

        void StartListeningForApplicationStatus ()
        {
            if (!StatusIndCallbackIsSet) {
                StatusIndCallbackIsSet = true;
                NcApplication.Instance.StatusIndEvent += StatusIndicatorCallback;
            }
        }

        void StopListeningForApplicationStatus ()
        {
            if (StatusIndCallbackIsSet) {
                NcApplication.Instance.StatusIndEvent -= StatusIndicatorCallback;
                StatusIndCallbackIsSet = false;
            }
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            Update ();
        }

        public override void ViewDidAppear (bool animated)
        {
            base.ViewDidAppear (animated);
            IsVisible = true;
            if (!IsSyncingComplete) {
                activityIndicatorView.StartAnimating ();
            }
            if (DismissOnVisible) {
                DismissAfterDelay ();
            }
        }

        public override void ViewWillDisappear (bool animated)
        {
            base.ViewDidDisappear (animated);
            IsVisible = false;
            activityIndicatorView.StopAnimating ();
        }

        void Complete ()
        {
            IsSyncingComplete = true;
            Account.ConfigurationInProgress = McAccount.ConfigurationInProgressEnum.Done;
            Account.Update ();
            StopListeningForApplicationStatus ();
            Update ();
            if (IsVisible) {
                Log.Info (Log.LOG_UI, "AccountSyncingViewController will set dismiss delay immediately");
                DismissAfterDelay ();
            } else {
                Log.Info (Log.LOG_UI, "AccountSyncingViewController will set dismiss delay on visible");
                DismissOnVisible = true;
            }
        }

        void Update ()
        {
            if (IsViewLoaded) {
                if (IsSyncingComplete) {
                    if (IsVisible) {
                        activityIndicatorView.StopAnimating ();
                    }
                    NavigationItem.Title = "Account Created";
                    statusLabel.Text = "Your account is ready!";
                } else {
                    if (IsVisible) {
                        activityIndicatorView.StopAnimating ();
                    }
                    NavigationItem.Title = "Syncing...";
                    statusLabel.Text = "Syncing your inbox...";
                }
            }
        }

        void DismissAfterDelay ()
        {
            Log.Info (Log.LOG_UI, "AccountSyncingViewController starting dismiss timer");
            DismissTimer = new NcTimer ("AccountSyncViewControllerDismiss", (state) => {
                InvokeOnUIThread.Instance.Invoke (() => {
                    Dismiss ();
                });
            }, null, TimeSpan.FromSeconds(2), TimeSpan.Zero);

        }

        private void Dismiss ()
        {
            Log.Info (Log.LOG_UI, "AccountSyncingViewController dismissing by calling delegate");
            DismissTimer.Dispose ();
            DismissTimer = null;
            AccountDelegate.AccountSyncingViewControllerDidComplete (this);
        }

        private void StatusIndicatorCallback (object sender, EventArgs e)
        {
            if (!StatusIndCallbackIsSet) {
                Log.Info (Log.LOG_UI, "AccountSyncingViewController ignoring status callback because listening has been disabled");
                return;
            }
            var s = (StatusIndEventArgs)e;
            if (s.Account != null && s.Account.Id == Account.Id) {
                var senderState = BackEnd.Instance.BackEndState (Account.Id, McAccount.AccountCapabilityEnum.EmailSender);
                var readerState = BackEnd.Instance.BackEndState (Account.Id, McAccount.AccountCapabilityEnum.EmailReaderWriter);
                Log.Info (Log.LOG_UI, "AccountSyncingViewController senderState {0}, readerState {1}", senderState, readerState);
                if ((senderState == BackEndStateEnum.PostAutoDPostInboxSync) && (readerState == BackEndStateEnum.PostAutoDPostInboxSync)) {
                    Log.Info (Log.LOG_UI, "AccountSyncingViewController saw PostAutoDBPostInboxSync for both sender and reader, account ID{0}", Account.Id);
                    Complete ();
                }
            }
        }
    }
}
