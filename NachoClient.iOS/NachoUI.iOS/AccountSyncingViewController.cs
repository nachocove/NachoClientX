// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using UIKit;
using NachoCore.Model;
using NachoCore;

namespace NachoClient.iOS
{

    public interface AccountSyncingViewControllerDelegate {
        void AccountSyncingViewControllerDidComplete (AccountSyncingViewController vc);
    }

    public partial class AccountSyncingViewController : UIViewController
    {

        public AccountSyncingViewControllerDelegate AccountDelegate;
        private bool StatusIndCallbackIsSet;
        private McAccount account;
        private bool IsSyncingComplete;
        private bool IsVisible;
        private bool DismissOnVisible;

        public McAccount Account {
            get {
                return account;
            }

            set {
                account = value;
                StartListeningForApplicationStatus ();
            }
        }

        public AccountSyncingViewController (IntPtr handle) : base (handle)
        {
            NavigationItem.HidesBackButton = true;
        }

        void StartListeningForApplicationStatus ()
        {
            if (!StatusIndCallbackIsSet) {
                StatusIndCallbackIsSet = true;
                NcApplication.Instance.StatusIndEvent += StatusIndicatorCallback;
            }
        }

        void StopListeningForApplicationStatus ()
        {
            if (StatusIndCallbackIsSet) {
                NcApplication.Instance.StatusIndEvent -= StatusIndicatorCallback;
                StatusIndCallbackIsSet = false;
            }
        }

        public override void ViewDidAppear (bool animated)
        {
            base.ViewDidAppear (animated);
            IsVisible = true;
            activityIndicatorView.StartAnimating ();
            if (DismissOnVisible) {
                DismissAfterDelay ();
            }
        }

        public override void ViewWillDisappear (bool animated)
        {
            base.ViewDidDisappear (animated);
            IsVisible = false;
            activityIndicatorView.StopAnimating ();
        }

        void Complete ()
        {
            IsSyncingComplete = true;
            Account.ConfigurationInProgress = McAccount.ConfigurationInProgressEnum.Done;
            Account.Update ();
            StopListeningForApplicationStatus ();
            IndicateComplete ();
            if (IsVisible) {
                DismissAfterDelay ();
            } else {
                DismissOnVisible = true;
            }
        }

        void IndicateComplete ()
        {
            activityIndicatorView.StopAnimating ();
            statusLabel.Text = "Your account is ready!";
        }

        void DismissAfterDelay ()
        {
            AccountDelegate.AccountSyncingViewControllerDidComplete (this);
        }

        private void StatusIndicatorCallback (object sender, EventArgs e)
        {
            var s = (StatusIndEventArgs)e;
            if (s.Account != null && s.Account.Id == Account.Id) {
                var senderState = BackEnd.Instance.BackEndState (Account.Id, McAccount.AccountCapabilityEnum.EmailSender);
                var readerState = BackEnd.Instance.BackEndState (Account.Id, McAccount.AccountCapabilityEnum.EmailReaderWriter);
                if ((senderState == BackEndStateEnum.PostAutoDPostInboxSync) && (readerState == BackEndStateEnum.PostAutoDPostInboxSync)) {
                    Complete ();
                }
            }
        }
    }
}
