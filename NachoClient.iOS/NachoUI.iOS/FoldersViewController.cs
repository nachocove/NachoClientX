// This file has been autogenerated from a class added in the UI designer.

using System;
using CoreGraphics;
using System.Collections.Generic;
using Foundation;
using UIKit;
using EventKit;
using System.IO;
using System.Linq;
using NachoCore;
using NachoCore.Model;
using NachoCore.Utils;
using NachoCore.ActiveSync;


namespace NachoClient.iOS
{
    public partial class FoldersViewController : NcUIViewController, INachoFolderChooser
    {
        UITableView TableView;
        FolderTableViewSource folderTableViewSource;

        bool EventHandlersAreSet;

        SwitchAccountButton switchAccountButton;

        public FoldersViewController () : base ()
        {
        }

        public FoldersViewController (IntPtr handle) : base (handle)
        {
        }

        int accountId;
        protected object cookie;
        protected bool modal;
        protected INachoFolderChooserParent owner;

        public void SetOwner (INachoFolderChooserParent owner, bool modal, int accountId, object cookie)
        {
            this.owner = owner;
            this.modal = modal;
            this.cookie = cookie;
            this.accountId = accountId;
        }

        public void DismissFolderChooser (bool animated, Action action)
        {
            owner = null;
            cookie = null;
            DismissViewController (animated, action);
        }

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();

            TableView = new UITableView (new CGRect (0, modal ? 64 : 0, View.Frame.Width, View.Frame.Height), UITableViewStyle.Grouped);
            TableView.SeparatorColor = A.Color_NachoBackgroundGray;
            TableView.BackgroundColor = A.Color_NachoBackgroundGray;
            TableView.TableFooterView = new UIView (new CGRect (0, 0, TableView.Frame.Width, 100));
            TableView.AccessibilityLabel = "Folder list";
            TableView.SectionHeaderHeight = 4;
            TableView.SectionFooterHeight = 4;
            View.AddSubview (TableView);

            var v = new UIView (new CGRect (0, 0, 1, 8));
            v.BackgroundColor = UIColor.Clear;
            TableView.TableHeaderView = v;
                
            if (modal) {
                NcAssert.False (0 == accountId);
                var navBar = new UINavigationBar (new CGRect (0, 20, View.Frame.Width, 44));
                navBar.BarStyle = UIBarStyle.Default;
                navBar.Translucent = false;
                navBar.Opaque = true;

                var navItem = new UINavigationItem ();
                navItem.Title = "Move to Folder";
                using (var image = UIImage.FromBundle ("modal-close")) {
                    var dismissButton = new NcUIBarButtonItem (image, UIBarButtonItemStyle.Plain, null);
                    dismissButton.AccessibilityLabel = "Dismiss";
                    dismissButton.Clicked += (object sender, EventArgs e) => {
                        DismissViewController (true, null);
                    };
                    navItem.LeftBarButtonItem = dismissButton;
                }
                navBar.Items = new UINavigationItem[] { navItem };

                var titleView = new UIView (new CGRect (0, 0, View.Frame.Width, 64));
                titleView.BackgroundColor = A.Color_NachoGreen;
                titleView.AddSubview (navBar);
                View.AddSubview (titleView);
            } else {
                NavigationController.NavigationBar.Translucent = false;
                var composeButton = new NcUIBarButtonItem ();
                Util.SetAutomaticImageForButton (composeButton, "contact-newemail");
                composeButton.AccessibilityLabel = "New message";
                composeButton.Clicked += (object sender, EventArgs e) => {
                    ComposeMessage ();
                };
                NavigationItem.RightBarButtonItem = composeButton;
                switchAccountButton = new SwitchAccountButton (switchAccountButtonPressed);
                switchAccountButton.SetAccountImage (NcApplication.Instance.Account);
                NavigationItem.TitleView = switchAccountButton;
                accountId = NcApplication.Instance.Account.Id;
            }
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);

            if (null == folderTableViewSource) {
                folderTableViewSource = new FolderTableViewSource (accountId, hideFakeFolders: modal);
                TableView.Source = folderTableViewSource;
                TableView.ReloadData ();
            } else {
                folderTableViewSource.Refresh (accountId);
                TableView.ReloadData ();
            }

            if (null != switchAccountButton) {
                NcAssert.False (modal);
                switchAccountButton.SetAccountImage (NcApplication.Instance.Account);
            }

            if (!EventHandlersAreSet) {
                folderTableViewSource.OnFolderSelected += FolderTableViewSource_OnFolderSelected;
                folderTableViewSource.OnAccountSelected += FolderTableViewSource_OnAccountSelected;
                folderTableViewSource.OnToggleClick += FolderTableViewSource_OnToggleClick;
                EventHandlersAreSet = true;
            }
        }

        void FolderTableViewSource_OnToggleClick (object sender, int uniqueId)
        {
            folderTableViewSource.Toggle (uniqueId);
            TableView.ReloadData ();
        }

        void FolderTableViewSource_OnAccountSelected (object sender, McAccount account)
        {
            NcAssert.False (modal);
            FolderLists.SetDefaultAccount (account.Id);
            folderTableViewSource.Refresh (NcApplication.Instance.Account.Id);
            TableView.ReloadData ();
        }

        void FolderTableViewSource_OnFolderSelected (object sender, McFolder folder)
        {
            switch (folder.Id) {
            case McFolder.INBOX_FAKE_FOLDER_ID:
                ShowInbox ();
                return;
            case McFolder.HOT_FAKE_FOLDER_ID:
                ShowHotList ();
                return;
            case McFolder.LTR_FAKE_FOLDER_ID:
                ShowLikelyToRead ();
                return;
            }

            folder.UpdateSet_LastAccessed (DateTime.UtcNow);
            if (null == owner) {
                if (folder.IsClientOwnedDraftsFolder () || folder.IsClientOwnedOutboxFolder ()) {
                    ShowDrafts (folder);
                } else {
                    ShowMessages (folder);
                }
            } else {
                owner.FolderSelected (this, folder, cookie);
            }
        }

        void ShowInbox ()
        {
            var viewController = new MessageListViewController ();
            var messages = NcEmailManager.Inbox (NcApplication.Instance.Account.Id);
            viewController.SetEmailMessages (messages);
            NavigationController.PushViewController (viewController, true);
        }

        void ShowHotList ()
        {
            var viewController = new MessageListViewController ();
            var messages = NcEmailManager.PriorityInbox (NcApplication.Instance.Account.Id);
            viewController.SetEmailMessages (messages);
            NavigationController.PushViewController (viewController, true);
        }

        void ShowLikelyToRead ()
        {
            var viewController = new MessageListViewController ();
            var messages = NcEmailManager.LikelyToReadInbox (NcApplication.Instance.Account.Id);
            viewController.SetEmailMessages (messages);
            NavigationController.PushViewController (viewController, true);
        }

        void ShowDrafts (McFolder folder)
        {
            var draftsList = new NachoDraftMessages (folder);
            var draftsListViewController = new MessageListViewController ();
            draftsListViewController.SetEmailMessages (draftsList);
            NavigationController.PushViewController (draftsListViewController, true);
        }

        void ShowMessages (McFolder folder)
        {
            var viewController = new MessageListViewController ();
            var messageList = new NachoEmailMessages (folder);
            viewController.SetEmailMessages (messageList);
            NavigationController.PushViewController (viewController, true);
        }

        void switchAccountButtonPressed ()
        {
            SwitchAccountViewController.ShowDropdown (this, SwitchToAccount);
        }

        void SwitchToAccount (McAccount account)
        {
            NcAssert.False (modal);
            accountId = account.Id;
            switchAccountButton.SetAccountImage (account);
            folderTableViewSource.Refresh (NcApplication.Instance.Account.Id);
            TableView.ReloadData ();
        }

        private void ComposeMessage ()
        {
            NcAssert.False (modal);
            var account = McAccount.EmailAccountForAccount (NcApplication.Instance.Account);
            var composeViewController = new MessageComposeViewController (account);
            composeViewController.Present ();
        }

    }
}
