// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Drawing;
using System.Collections.Generic;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using MonoTouch.EventKit;
using System.IO;
using NachoCore;
using NachoCore.Model;
using NachoCore.Utils;


namespace NachoClient.iOS
{
    public partial class FoldersViewController : UIViewController
    {
        public FoldersViewController (IntPtr handle) : base (handle)
        {
        }

        protected McAccount account;
        protected bool hasRecents = false;
        protected UILabel recentLabel;
        protected UILabel defaultsLabel;
        //protected UILabel yourFoldersLabel;
        protected UIView recentView;
        protected UIView defaultsView;
        //protected UIView yourFoldersView;
        protected UIScrollView scrollView;
        protected int rootFolderCount;

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();

            account = NcModel.Instance.Db.Table<McAccount> ().Where (x => x.AccountType == McAccount.AccountTypeEnum.Exchange).FirstOrDefault ();

            CreateView ();
            ConfigureFolders ();
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            if (null != this.NavigationController) {
                this.NavigationController.ToolbarHidden = true;
            }
            ConfigureView ();
        }

        public override void ViewDidAppear (bool animated)
        {
            base.ViewDidAppear (animated);
        }

        public override void ViewDidDisappear (bool animated)
        {
            base.ViewWillDisappear (animated);
            foreach (var v in defaultsView.Subviews) {
                v.RemoveFromSuperview ();
            }
        }

        public override bool HidesBottomBarWhenPushed {
            get {
                return this.NavigationController.TopViewController == this;
            }
        }

        public override void PrepareForSegue (UIStoryboardSegue segue, NSObject sender)
        {
            if (segue.Identifier == "FoldersToMessageList") {
                var holder = (SegueHolder)sender;
                var messageList = new NachoEmailMessages ((McFolder)holder.value);
                var messageListViewController = (MessageListViewController)segue.DestinationViewController;
                messageListViewController.SetEmailMessages (messageList);
                return;
            }

            Log.Info (Log.LOG_UI, "Unhandled segue identifer {0}", segue.Identifier);
            NcAssert.CaseError ();
        }

        const int RECENT_LABEL_TAG = 201;
        const int DEFAULT_LABEL_TAG = 202;
        const int YOUR_FOLDERS_LABEL_TAG = 203;

        const int RECENT_VIEW_TAG = 101;
        const int DEFAULT_VIEW_TAG = 102;
        const int YOUR_FOLDERS_VIEW_TAG = 103;

        protected void CreateView ()
        {
            NavigationItem.Title = "Folders";
            scrollView = new UIScrollView (new RectangleF (0, 0, View.Frame.Width, View.Frame.Height));

            float yOffset = 20f;

            float marginPadding = 15f;

            recentLabel = new UILabel (new RectangleF (20, yOffset, 160, 20));
            recentLabel.Tag = RECENT_LABEL_TAG;
            recentLabel.Text = "Recent Folders";
            recentLabel.Font = A.Font_AvenirNextDemiBold17;
            recentLabel.TextColor = A.Color_NachoGreen;
            recentLabel.Hidden = true;
            yOffset += recentLabel.Frame.Height;

            yOffset += 5;
            recentView = new UIView (new RectangleF (marginPadding / 2, yOffset, View.Frame.Width - marginPadding, 44));
            recentView.Layer.CornerRadius = 4;
            recentView.Tag = RECENT_VIEW_TAG;
            recentView.BackgroundColor = UIColor.White;
            recentView.Hidden = true;
            yOffset += recentView.Frame.Height;

            yOffset += 20;
            defaultsLabel = new UILabel (new RectangleF (20, yOffset, 160, 20));
            defaultsLabel.Tag = DEFAULT_LABEL_TAG;
            defaultsLabel.Text = "Default Folders";
            defaultsLabel.Font = A.Font_AvenirNextDemiBold17;
            defaultsLabel.TextColor = A.Color_NachoGreen;
            defaultsLabel.Hidden = true;
            yOffset += defaultsLabel.Frame.Height;

            yOffset += 5;
            defaultsView = new UIView (new RectangleF (marginPadding / 2, yOffset, View.Frame.Width - marginPadding, 44));
            defaultsView.Layer.CornerRadius = 4;
            defaultsView.Tag = DEFAULT_VIEW_TAG;
            defaultsView.BackgroundColor = UIColor.White;
            defaultsView.Hidden = true;
            yOffset += defaultsView.Frame.Height;

            yOffset += 20;
            scrollView.Add (recentLabel);
            scrollView.Add (recentView);

            scrollView.Add (defaultsLabel);
            scrollView.Add (defaultsView);
            scrollView.BackgroundColor = A.Color_NachoBackgroundGray;
            scrollView.ContentSize = new SizeF (View.Frame.Width, yOffset);
            View.Add (scrollView);
        }

        protected void ConfigureView ()
        {
            if (hasRecents) {
                recentLabel.Hidden = false;
                recentView.Hidden = false;
            } 
            List<string> list = new List<string> (new string[] { "Inbox", "Archive", "Trash" });

            int index = 0;
            foreach (var f in list) {
                CreateFolderCell (0, recentView, index, index, f, false, false, 100 + index);
                index++;
            }
            recentView.Frame = new RectangleF (recentView.Frame.X, recentView.Frame.Y, recentView.Frame.Width, list.Count * 44);

            defaultsLabel.Hidden = false;
            defaultsView.Hidden = false;

            index = 0;
            foreach (var f in flattenedFolderList) {
                var isRootFolder = true;
                if (f.indentLevel == 0) {
                    rootFolderCount++;
                    isRootFolder = false;
                }
                CreateFolderCell (f.indentLevel, defaultsView, rootFolderCount - 1, index, f.folderName, HasSubFolders (index), isRootFolder, 200 + index);
                index++;
            }

            LayoutView ();
        }

        protected void LayoutView ()
        {
            var yOffset = 0f;
            if (hasRecents) {
                yOffset += recentView.Frame.Bottom;
            }

            yOffset += 20;
            defaultsLabel.Frame = new RectangleF (20, yOffset, 160, 20);
            yOffset += 25;
            var rootFolderIndex = 0;
            for (int i = 0; i < flattenedFolderList.Count; i++) {
                var cell = defaultsView.ViewWithTag (200 + i) as UIView;
                if (!cell.Hidden) {
                    cell.Frame = new RectangleF (cell.Frame.X, 44 * rootFolderIndex, cell.Frame.Width, 44);
                    rootFolderIndex++;
                } else {
                    MatchParentY (cell);
                }
            }
            var folderListHeight = rootFolderIndex * 44;
            defaultsView.Frame = new RectangleF (defaultsView.Frame.X, yOffset, defaultsView.Frame.Width, folderListHeight);
            yOffset += folderListHeight;

            yOffset += 45 + 64;
            scrollView.ContentSize = new SizeF (View.Frame.Width, yOffset);
        }

        public void MatchParentY (UIView cell)
        {
            int index = cell.Tag - 200;
            int rootIndex = index;
            while (index >= 0) {
                if (flattenedFolderList [rootIndex].indentLevel > flattenedFolderList [index].indentLevel) {
                    cell.Frame = new RectangleF (cell.Frame.X, scrollView.ViewWithTag (index + 200).Frame.Y, cell.Frame.Width, cell.Frame.Height); 
                    cell.Hidden = true;
                    return;
                }
                index--;
            }
        }

        protected void CreateFolderCell (int subLevel, UIView parentView, int relativeIndex, int index, string title, bool subFolders, bool isHidden, int tag)
        {
            var indentation = subLevel * 10;
            UIView cell = new UIView (new RectangleF (5 + indentation, 44 * relativeIndex, parentView.Frame.Width - 10 - indentation, 44));
            cell.BackgroundColor = UIColor.White;
            var cellTap = new UITapGestureRecognizer ();
            cellTap.AddTarget (() => {
                var folder = GetFolder (index);
                PerformSegue ("FoldersToMessageList", new SegueHolder (folder));
            });
            cell.AddGestureRecognizer (cellTap);

            UILabel label = new UILabel (new RectangleF (45, 0, cell.Frame.Width - 45, 44));
            label.Text = title;
            label.Font = A.Font_AvenirNextMedium14;
            label.TextColor = A.Color_NachoGreen;
            cell.Add (label);

            UIImageView imageView = new UIImageView (new RectangleF (10, cell.Frame.Height / 2 - 10, 20, 20));
            imageView.Image = UIImage.FromBundle ("icn-folder");
            cell.Add (imageView);

            if (0 != index) {
                Util.AddHorizontalLine (45, 0, cell.Frame.Width - 40, A.Color_NachoBorderGray, cell);
            }

            if (subFolders) {
                UIButton expandButton = new UIButton (UIButtonType.RoundedRect);
                expandButton.Frame = new RectangleF (cell.Frame.Width - 30, cell.Frame.Height / 2 - 5, 20, 10);
                expandButton.SetImage (UIImage.FromBundle ("email-readmore-gray"), UIControlState.Normal);
                expandButton.TintColor = A.Color_NachoIconGray;
                expandButton.Tag = tag + 100;
                expandButton.TouchUpInside += (sender, e) => {
                    defaultsView.BringSubviewToFront (cell);
                    ToggleExpandableCell (index);
                };
                cell.Add (expandButton);
            }
            cell.Hidden = isHidden;
            cell.Tag = tag;
            parentView.Add (cell);
        }

        public void ToggleExpandableCell (int index)
        {
            var expandButton = scrollView.ViewWithTag (300 + index) as UIButton;
            int count = CountOfNextLevelSubFolders (index);
            int rootIndex = index;
            index++;
            if (!expandButton.Selected) {
                for (int i = 0; i < count; i++) {
                    var cell = scrollView.ViewWithTag (200 + index) as UIView;
                    if (flattenedFolderList [index].indentLevel == flattenedFolderList [rootIndex].indentLevel + 1) {
                        cell.Hidden = false;
                    }
                    index++;
                }
                UIView.Animate (.2, 0, UIViewAnimationOptions.CurveLinear,
                    () => {
                        LayoutView ();
                    },
                    () => {
                    }
                );
                expandButton.Selected = true;
                return;
            } else {
                for (int i = 0; i < count; i++) {
                    var cell = scrollView.ViewWithTag (200 + index) as UIView;
                    cell.Hidden = true;
                    index++;
                }
                UIView.Animate (.2, 0, UIViewAnimationOptions.CurveLinear,
                    () => {
                        LayoutView ();
                    },
                    () => {
                    }
                );
                expandButton.Selected = false;
                return;
            }
        }

        NachoFolders Folders;
        public List<McFolder> foldersToMcFolders = new List<McFolder> ();
        public List<FolderStruct> nestedFolderList = new List<FolderStruct> ();
        public List<FlattenedFolderStruct> flattenedFolderList = new List<FlattenedFolderStruct> ();
        public List<UITableViewCell> FolderCells = new List<UITableViewCell> ();

        public void ConfigureFolders ()
        {
            Folders = new NachoFolders (NachoFolders.FilterForEmail);
            ConvertFoldersToMcFolders ();
            CreateNestedFolderList ();
            FlattenNestedFolderList (0, nestedFolderList);
        }

        public void ConvertFoldersToMcFolders ()
        {
            for (int i = 0; i < Folders.Count (); i++) {
                foldersToMcFolders.Add (Folders.GetFolder (i));
            }
        }

        public void CreateNestedFolderList ()
        {
            foreach (var folder in foldersToMcFolders) {
                if (Int32.Parse (folder.ParentId) == 0) {
                    int folderID = folder.Id;
                    string fname = folder.DisplayName;
                    List<FolderStruct> subFolders = new List<FolderStruct> ();
                    subFolders = GetSubFolders (folder.Id, folder.AccountId, folder.ServerId, 0);
                    nestedFolderList.Add (new FolderStruct (folderID, subFolders, fname));
                }
            }
        }

        public List<FolderStruct> GetSubFolders (int fID, int accountID, string serverID, int indentLevel)
        {
            indentLevel += 1;
            List<FolderStruct> subFolders = new List<FolderStruct> ();
            List<McFolder> folds = new List<McFolder> ();
            folds = McFolder.QueryByParentId (accountID, serverID);

            foreach (McFolder f in folds) {
                subFolders.Add (new FolderStruct (f.Id, GetSubFolders (f.Id, f.AccountId, f.ServerId, indentLevel), f.DisplayName));
            }
            return subFolders;
        }

        public void FlattenNestedFolderList (int indentlevel, List<FolderStruct> nestedFoldersList)
        {
            foreach (FolderStruct f in nestedFoldersList) {

                flattenedFolderList.Add (new FlattenedFolderStruct (f.folderName, f.folderID, indentlevel));

                if (f.subFolders.Count != 0) {
                    FlattenNestedFolderList (indentlevel + 1, f.subFolders);
                }
            }
        }

        public bool HasSubFolders (int index)
        {
            if (isLastCell (index)) {
                return false;
            }
            if (flattenedFolderList [index + 1].indentLevel > flattenedFolderList [index].indentLevel) {
                return true;
            }
            return false;

        }

        public int CountOfNextLevelSubFolders (int index)
        {
            if (isLastCell (index)) {
                return 0;
            }

            var rootFolderindex = index;

            int count = 0;
            if (HasSubFolders (index)) {
                if (isLastCell (index + 1)) {
                    return 1;
                }
                index++;
            }
            while (flattenedFolderList [rootFolderindex].indentLevel != flattenedFolderList [index].indentLevel) {
                count++;
                index++;
                if (isLastCell (index) && flattenedFolderList [rootFolderindex].indentLevel != flattenedFolderList [index].indentLevel) {
                    count++;
                    return count;
                }
            }
            return count;
        }

        public bool isLastCell (int index)
        {
            if (index == flattenedFolderList.Count - 1) {
                return true;
            }
            return false;
        }

        public class FolderStruct
        {
            public int folderID { get; set; }

            public string folderName { get; set; }

            public List <FolderStruct> subFolders { get; set; }

            public FolderStruct ()
            {

            }

            public FolderStruct (int fid, List<FolderStruct> sf, string fn)
            {
                folderID = fid;
                subFolders = sf;
                folderName = fn;
            }
        }

        public class FlattenedFolderStruct
        {
            public string folderName { get; set; }

            public int folderID { get; set; }

            public int indentLevel { get; set; }

            public FlattenedFolderStruct (string fn, int fid, int il)
            {
                folderName = fn;
                folderID = fid;
                indentLevel = il;
            }
        }

        public McFolder GetFolder (int index)
        {
            return Folders.GetFolderByFolderID (flattenedFolderList [index].folderID);
        }
            
    }

}
