// This file has been autogenerated from a class added in the UI designer.

using System;
using System.IO;
using System.Linq;
using System.Text;
using System.Collections.Generic;
using System.Drawing;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using NachoCore;
using NachoCore.Model;
using NachoCore.Utils;
using MimeKit;
using NachoCore.Brain;
using System.Text.RegularExpressions;

namespace NachoClient.iOS
{
    public partial class ContactDetailViewController : NcUIViewControllerNoLeaks, IMessageTableViewSourceDelegate, INachoMessageEditorParent, INachoCalendarItemEditorParent, INachoFolderChooserParent, INachoNotesControllerParent, INachoDateControllerParent
    {
        public McContact contact;

        protected UIColor originalBarTintColor;
        protected UIBarButtonItem editContact;

        protected const string UICellReuseIdentifier = "UICell";
        protected const string EmailMessageReuseIdentifier = "EmailMessage";
        protected MessageTableViewSource messageSource;
        protected HashSet<int> MultiSelect = null;

        protected int selectedSegment = 0;
        protected int remainingContactDetails = 0;

        protected const float PADDING = 18f;
        protected const float VERTICAL_PADDING = 20f;
        protected const float SEGMENTED_CONTROL_HEIGHT = 30f;

        protected const int HEADER_INITIALS_CIRCLE_TAG = 100;
        protected const int HEADER_NAME_TAG = 101;
        protected const int HEADER_TITLE_TAG = 102;
        protected const int HEADER_CALL_VIEW_TAG = 103;
        protected const int HEADER_EMAIL_VIEW_TAG = 104;
        protected const int HEADER_VIP_BUTTON_TAG = 105;
        protected const int HEADER_PORTRAIT_TAG = 106;

        protected const int SEGMENTED_CONTROL_TAG = 200;
        protected const int SEGMENTED_VIEW_HOLDER_TAG = 201;

        protected const int CONTACT_INFO_VIEW_TAG = 300;
        protected const int TRANSIENT_TAG_INITIAL_VALUE = 301;
        protected int variableTransientTag = TRANSIENT_TAG_INITIAL_VALUE;

        protected const int INTERACTIONS_TABLE_VIEW_TAG = 400;

        protected const int NOTES_VIEW_TAG = 500;
        protected const int NOTES_TEXT_VIEW_TAG = 501;
        protected const int NOTES_EDIT_BUTTON_TAG = 502;

        protected UITapGestureRecognizer headerCallViewGestureTapGesture;
        protected UITapGestureRecognizer.Token headerCallViewGestureTapGestureHandlerToken;

        protected UITapGestureRecognizer headerEmailViewTapGesture;
        protected UITapGestureRecognizer.Token headerEmailViewTapGestureHandlerToken;

        protected class TapGesturePair
        {
            public UITapGestureRecognizer recognizer;
            public UITapGestureRecognizer.Token token;
            public int viewTag;

            public TapGesturePair (UITapGestureRecognizer recognizer, UITapGestureRecognizer.Token token, int viewTag)
            {
                this.recognizer = recognizer;
                this.token = token;
                this.viewTag = viewTag;
            }
        }

        protected List<TapGesturePair> tapGestures = new List<TapGesturePair> ();

        public ContactDetailViewController (IntPtr handle) : base (handle)
        {
            messageSource = new MessageTableViewSource ();
            MultiSelect = new HashSet<int> ();
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            if (null != this.NavigationController) {
                this.NavigationController.ToolbarHidden = true;
                originalBarTintColor = this.NavigationController.NavigationBar.BarTintColor;
            }

            Util.ConfigureNavBar (false, NavigationController);
            NcApplication.Instance.StatusIndEvent += StatusIndicatorCallback;

            var SegmentedControl = (UISegmentedControl)View.ViewWithTag (SEGMENTED_CONTROL_TAG);
            if (null != SegmentedControl) {
                SegmentedControl.SelectedSegment = selectedSegment;
                SegmentedControl.SendActionForControlEvents (UIControlEvent.ValueChanged);
            }
        }

        public override void ViewWillDisappear (bool animated)
        {
            base.ViewWillDisappear (animated);
            if (null != this.NavigationController) {
                this.NavigationController.ToolbarHidden = true;
                this.NavigationController.NavigationBar.BarTintColor = originalBarTintColor;

            }
            Util.ConfigureNavBar (false, NavigationController);
            NcApplication.Instance.StatusIndEvent -= StatusIndicatorCallback;

            var SegmentedControl = (UISegmentedControl)View.ViewWithTag (SEGMENTED_CONTROL_TAG);
            if (null != SegmentedControl) {
                selectedSegment = SegmentedControl.SelectedSegment;
            }
        }

        public override bool HidesBottomBarWhenPushed {
            get {
                return this.NavigationController.TopViewController == this;
            }
        }

        public override void PrepareForSegue (UIStoryboardSegue segue, NSObject sender)
        {
            if (segue.Identifier.Equals ("ContactToNotes")) {
                var dc = (NotesViewController)segue.DestinationViewController;
                dc.SetOwner (this);
                return;
            }

            if (segue.Identifier.Equals ("ContactToEmailCompose")) {
                var dc = (MessageComposeViewController)segue.DestinationViewController;
                var holder = (SegueHolder)sender;
                var address = (string)holder.value;
                dc.SetEmailPresetFields (new NcEmailAddress (NcEmailAddress.Kind.To, address));
                if (null != holder.value2) {
                    dc.SetQRType (NcQuickResponse.QRTypeEnum.Compose);
                }
                return;
            }
            if (segue.Identifier.Equals ("ContactToContactEdit")) {
                return;
            }
            if (segue.Identifier == "NachoNowToMessagePriority") {
                var holder = (SegueHolder)sender;
                var thread = (McEmailMessageThread)holder.value;
                var vc = (INachoDateController)segue.DestinationViewController;
                vc.Setup (this, thread, DateControllerType.Defer);
                return;
            }
            if (segue.Identifier == "MessageListToFolders") {
                var vc = (INachoFolderChooser)segue.DestinationViewController;
                var h = (SegueHolder)sender;
                vc.SetOwner (this, true, h);
                return;
            }
            if (segue.Identifier == "NachoNowToMessageView") {
                var vc = (MessageViewController)segue.DestinationViewController;
                var holder = (SegueHolder)sender;
                vc.thread = (McEmailMessageThread)holder.value;           
                return;
            }
            if (segue.Identifier == "NachoNowToEditEvent") {
                var vc = (EditEventViewController)segue.DestinationViewController;
                var holder = (SegueHolder)sender;
                var c = (McCalendar)holder.value;
                vc.SetCalendarItem (c);
                vc.SetOwner (this);
                return;
            }
            Log.Info (Log.LOG_UI, "Unhandled segue identifer {0}", segue.Identifier);
            NcAssert.CaseError ();
        }

        protected override void CreateViewHierarchy ()
        {
            contentView.BackgroundColor = A.Color_NachoBackgroundGray;
            View.BackgroundColor = A.Color_NachoBackgroundGray;

            Util.SetBackButton (NavigationController, NavigationItem, A.Color_NachoBlue);
            NavigationItem.Title = "Contacts";

            editContact = new UIBarButtonItem ();
            editContact.Image = UIImage.FromBundle ("gen-edit");
            editContact.Clicked += EditButtonClicked;
            NavigationItem.SetRightBarButtonItem (editContact, true); 

            //CONTACT HEADER SECTION
            UIView headerView = new UIView (new RectangleF (15, VERTICAL_PADDING, View.Frame.Width - 30, 147));
            headerView.Layer.CornerRadius = 6.0f;
            headerView.Layer.BorderColor = A.Color_NachoBorderGray.CGColor;
            headerView.Layer.BorderWidth = 1.0f;
            headerView.BackgroundColor = UIColor.White;
            View.AddSubview (headerView);

            UIButton vipButton = new UIButton (new RectangleF (headerView.Frame.Right - 48, 10, VERTICAL_PADDING, VERTICAL_PADDING));
            vipButton.Tag = HEADER_VIP_BUTTON_TAG;
            vipButton.SetImage (UIImage.FromBundle ("contacts-vip"), UIControlState.Normal);
            vipButton.TouchUpInside += VipButtonTouchUpInside;
            headerView.AddSubview (vipButton);

            UILabel initialsCircleLabel = new UILabel (new RectangleF (PADDING, VERTICAL_PADDING, 60, 60));
            initialsCircleLabel.Font = A.Font_AvenirNextRegular24;
            initialsCircleLabel.BackgroundColor = A.Color_NachoLightText;
            initialsCircleLabel.TextColor = UIColor.White;
            initialsCircleLabel.TextAlignment = UITextAlignment.Center;
            initialsCircleLabel.LineBreakMode = UILineBreakMode.Clip;
            initialsCircleLabel.Layer.CornerRadius = 30;
            initialsCircleLabel.Layer.MasksToBounds = true;
            initialsCircleLabel.Layer.BorderColor = A.Color_NachoBorderGray.CGColor;
            initialsCircleLabel.Layer.BorderWidth = .5f;
            initialsCircleLabel.Tag = HEADER_INITIALS_CIRCLE_TAG;
            headerView.AddSubview (initialsCircleLabel);

            UIImageView userImageView = new UIImageView (new RectangleF (PADDING, VERTICAL_PADDING, 60, 60));
            userImageView.Layer.BorderColor = A.Color_NachoBorderGray.CGColor;
            userImageView.Layer.BorderWidth = .5f;
            userImageView.Layer.CornerRadius = 30;
            userImageView.Layer.MasksToBounds = true;
            userImageView.Tag = HEADER_PORTRAIT_TAG;
            userImageView.Hidden = true;
            headerView.AddSubview (userImageView);

            UILabel nameLabel = new UILabel (new RectangleF (initialsCircleLabel.Frame.Right + 16, 31, 190, 20));
            nameLabel.Font = A.Font_AvenirNextDemiBold17;
            nameLabel.TextColor = A.Color_NachoGreen;
            nameLabel.TextAlignment = UITextAlignment.Left;
            nameLabel.BackgroundColor = UIColor.White;
            nameLabel.Tag = HEADER_NAME_TAG;
            headerView.AddSubview (nameLabel);

            UILabel titleLabel = new UILabel (new RectangleF (nameLabel.Frame.X, nameLabel.Frame.Bottom + 6, nameLabel.Frame.Width, nameLabel.Frame.Height - 5));
            titleLabel.Font = A.Font_AvenirNextMedium14;
            titleLabel.TextColor = A.Color_NachoTextGray;
            titleLabel.Tag = HEADER_TITLE_TAG;
            headerView.AddSubview (titleLabel);

            Util.AddHorizontalLine (0, initialsCircleLabel.Frame.Bottom + PADDING, headerView.Frame.Width, A.Color_NachoBorderGray, headerView);
            Util.AddVerticalLine (headerView.Frame.Width / 2, initialsCircleLabel.Frame.Bottom + PADDING, headerView.Frame.Height - (initialsCircleLabel.Frame.Bottom + PADDING), A.Color_NachoBorderGray, headerView);

            UIView callView = new UIView (new RectangleF (0, initialsCircleLabel.Frame.Bottom + PADDING, headerView.Frame.Width / 2, headerView.Frame.Height - (initialsCircleLabel.Frame.Bottom + PADDING)));
            callView.Tag = HEADER_CALL_VIEW_TAG;
            callView.BackgroundColor = UIColor.Clear;
            headerCallViewGestureTapGesture = new UITapGestureRecognizer ();
            headerCallViewGestureTapGestureHandlerToken = headerCallViewGestureTapGesture.AddTarget (DefaultCallTapHandler);
            callView.AddGestureRecognizer (headerCallViewGestureTapGesture);
            headerView.AddSubview (callView);

            UIImageView callIcon;
            using (var image = UIImage.FromBundle ("contacts-call")) {
                callIcon = new UIImageView (image);
            }
            callIcon.Frame = new RectangleF (40, 11, callIcon.Frame.Height, callIcon.Frame.Width);
            callView.AddSubview (callIcon);

            UILabel callLabel = new UILabel (new RectangleF (callIcon.Frame.Right + 10, 15, 50, 15));
            callLabel.TextColor = A.Color_NachoGreen;
            callLabel.Font = A.Font_AvenirNextMedium14;
            callLabel.Text = "Call";
            callLabel.TextAlignment = UITextAlignment.Left;
            callLabel.SizeToFit ();
            callView.AddSubview (callLabel);

            UIView emailView = new UIView (new RectangleF (headerView.Frame.Width / 2, initialsCircleLabel.Frame.Bottom + PADDING, headerView.Frame.Width, headerView.Frame.Height - (initialsCircleLabel.Frame.Bottom + PADDING)));
            emailView.Tag = HEADER_EMAIL_VIEW_TAG;
            emailView.BackgroundColor = UIColor.Clear;
            headerEmailViewTapGesture = new UITapGestureRecognizer ();
            headerEmailViewTapGestureHandlerToken = headerEmailViewTapGesture.AddTarget (DefaultEmailTapHandler);
            emailView.AddGestureRecognizer (headerEmailViewTapGesture);
            headerView.AddSubview (emailView);

            UIImageView emailIcon;
            using (var image = UIImage.FromBundle ("contacts-email")) {
                emailIcon = new UIImageView (image);
            }
            emailIcon.Frame = new RectangleF (35, 11, emailIcon.Frame.Height, emailIcon.Frame.Width);
            emailView.AddSubview (emailIcon);

            UILabel emailLabel = new UILabel (new RectangleF (emailIcon.Frame.Right + 10, 15, 50, 15));
            emailLabel.TextColor = A.Color_NachoGreen;
            emailLabel.Font = A.Font_AvenirNextMedium14;
            emailLabel.Text = "Email";
            emailLabel.TextAlignment = UITextAlignment.Left;
            emailLabel.SizeToFit ();
            emailView.AddSubview (emailLabel);

            float yOffset = headerView.Frame.Bottom + 12;

            UIView segmentedViewHolder = new UIView (new RectangleF (15, yOffset, View.Frame.Width - 30, 100));
            segmentedViewHolder.Layer.BorderColor = A.Color_NachoBorderGray.CGColor;
            segmentedViewHolder.Layer.BorderWidth = 1.0f;
            segmentedViewHolder.Layer.CornerRadius = 6.0f;
            segmentedViewHolder.Tag = SEGMENTED_VIEW_HOLDER_TAG;
            segmentedViewHolder.BackgroundColor = UIColor.White;
            View.AddSubview (segmentedViewHolder);

            //SEGMENTED CONTROL
            var segmentedControl = new UISegmentedControl ();
            segmentedControl.Frame = new RectangleF (PADDING, VERTICAL_PADDING, segmentedViewHolder.Frame.Width - (PADDING * 2), SEGMENTED_CONTROL_HEIGHT);
            segmentedControl.TintColor = A.Color_NachoGreen;
            segmentedControl.InsertSegment ("Contact", 0, false);
            segmentedControl.InsertSegment ("Interactions", 1, false);
            segmentedControl.InsertSegment ("Notes", 2, false);
            segmentedControl.SelectedSegment = 0;

            var segmentedControlTextNormal = new UITextAttributes ();
            segmentedControlTextNormal.Font = A.Font_AvenirNextDemiBold14;
            segmentedControlTextNormal.TextColor = A.Color_NachoGreen;

            var segmentedControlTextSelected = new UITextAttributes ();
            segmentedControlTextSelected.Font = A.Font_AvenirNextDemiBold14;
            segmentedControlTextSelected.TextColor = UIColor.White;
            segmentedControl.ValueChanged += SegmentedControlHandler;
            segmentedControl.Tag = SEGMENTED_CONTROL_TAG;
            segmentedControl.SetTitleTextAttributes (segmentedControlTextNormal, UIControlState.Normal);
            segmentedControl.SetTitleTextAttributes (segmentedControlTextSelected, UIControlState.Selected);
            segmentedViewHolder.AddSubview (segmentedControl);

            //CONTACT INFO
            UIScrollView contactInfoScrollView = new UIScrollView (new RectangleF (PADDING, segmentedControl.Frame.Bottom + 5, segmentedViewHolder.Frame.Width - (PADDING * 2), View.Frame.Height - segmentedViewHolder.Frame.Top - 80 - 64));
            contactInfoScrollView.BackgroundColor = UIColor.White;
            contactInfoScrollView.Tag = CONTACT_INFO_VIEW_TAG;
            segmentedViewHolder.AddSubview (contactInfoScrollView);

            //INTERACTIONS
            UITableView interactionsTableView = new UITableView (new RectangleF (0, segmentedControl.Frame.Bottom + 4, segmentedViewHolder.Frame.Width, View.Frame.Height - segmentedViewHolder.Frame.Top - 80 - 64));
            interactionsTableView.Tag = INTERACTIONS_TABLE_VIEW_TAG;
            interactionsTableView.Hidden = true;
            interactionsTableView.BackgroundColor = UIColor.White;
            segmentedViewHolder.AddSubview (interactionsTableView);

            //NOTES
            UIView notesView = new UIView (new RectangleF (PADDING, segmentedControl.Frame.Bottom, segmentedViewHolder.Frame.Width - (PADDING * 2), View.Frame.Height - segmentedViewHolder.Frame.Top - 80 - 64));
            notesView.Tag = NOTES_VIEW_TAG;
            UITextView notesTextView = new UITextView (new RectangleF (0, 5, notesView.Frame.Width, notesView.Frame.Height - 45));
            notesTextView.Font = A.Font_AvenirNextRegular14;
            notesTextView.Editable = false;
            notesTextView.TextColor = A.Color_NachoBlack;
            notesTextView.BackgroundColor = UIColor.White;
            notesTextView.Tag = NOTES_TEXT_VIEW_TAG;
            notesTextView.ScrollEnabled = true;
            notesView.AddSubview (notesTextView);

            segmentedViewHolder.AddSubview (notesView);
        }

        protected void EditButtonClicked (object sender, EventArgs e)
        {
            switch (selectedSegment) {
            case 0:
                //TODO: Edit Contacts
                break;
            case 1:
                //TODO: Multi-Select
                break;
            case 2:
                PerformSegue ("ContactToNotes", new SegueHolder (contact));
                break;
            }
        }

        protected void LayoutView ()
        {
            UIView segmentedViewHolder = (UIView)View.ViewWithTag (SEGMENTED_VIEW_HOLDER_TAG);
            UIScrollView contactInfoScrollView = (UIScrollView)View.ViewWithTag (CONTACT_INFO_VIEW_TAG);
            UITableView interactionsTableView = (UITableView)View.ViewWithTag (INTERACTIONS_TABLE_VIEW_TAG);
            UIView notesView = (UIView)View.ViewWithTag (NOTES_VIEW_TAG);

            switch (selectedSegment) {
            case 0:
                SetViewHeight (segmentedViewHolder, VERTICAL_PADDING + SEGMENTED_CONTROL_HEIGHT + contactInfoScrollView.Frame.Height + VERTICAL_PADDING / 2);
                break;
            case 1:
                SetViewHeight (segmentedViewHolder, VERTICAL_PADDING + SEGMENTED_CONTROL_HEIGHT + interactionsTableView.Frame.Height + VERTICAL_PADDING / 2);
                break;
            case 2:
                SetViewHeight (segmentedViewHolder, VERTICAL_PADDING + SEGMENTED_CONTROL_HEIGHT + notesView.Frame.Height + VERTICAL_PADDING / 2);
                break;
            }
        }

        protected override void ConfigureAndLayout ()
        {
            UpdateVipButton ();

            UIColor userBackgroundColor;

            if (null == contact) {
                var unavailableTitle = (UILabel)View.ViewWithTag (HEADER_TITLE_TAG);
                unavailableTitle.Text = "Contact is unavailable.";
                return;
            }
            if (0 == contact.EmailAddresses.Count) {
                userBackgroundColor = Util.ColorForUser (Util.PickRandomColorForUser ());
            } else {
                var emailAddressAttribute = contact.EmailAddresses [0];
                var emailAddress = McEmailAddress.QueryById<McEmailAddress> (emailAddressAttribute.EmailAddress);
                userBackgroundColor = Util.ColorForUser (emailAddress.ColorIndex);
            }

            UILabel headerInitialsLabel = (UILabel)View.ViewWithTag (HEADER_INITIALS_CIRCLE_TAG);
            UIImageView headerPortraitImageView = (UIImageView)View.ViewWithTag (HEADER_PORTRAIT_TAG);

            headerInitialsLabel.Hidden = true;
            headerPortraitImageView.Hidden = true;

            if (0 == contact.PortraitId) {
                headerInitialsLabel.BackgroundColor = userBackgroundColor; 
                headerInitialsLabel.Text = NachoCore.Utils.ContactsHelper.GetInitials (contact);
                headerInitialsLabel.Hidden = false;

            } else {
                headerPortraitImageView.Image = Util.ImageOfContact (contact);
                headerPortraitImageView.Hidden = false;
            }

            UILabel headerNameLabel = (UILabel)View.ViewWithTag (HEADER_NAME_TAG);
            headerNameLabel.Text = contact.GetDisplayNameOrEmailAddress ();

            UILabel headerTitleLabel = (UILabel)View.ViewWithTag (HEADER_TITLE_TAG);
            headerTitleLabel.Text = GetTitleFromContact ();

            if (tapGestures.Count > 0) {
                foreach (var v in tapGestures.ToList()) {
                    UIView view;
                    if (null == (view = View.ViewWithTag (v.viewTag))) {
                        break;
                    }
                    v.recognizer.RemoveTarget (v.token);
                    view.RemoveFromSuperview ();
                    tapGestures.Remove (v);
                }
                variableTransientTag = TRANSIENT_TAG_INITIAL_VALUE;
            }

            //CONFIGURE CONTACT INFO VIEW
            UIScrollView contactInfoScrollView = (UIScrollView)View.ViewWithTag (CONTACT_INFO_VIEW_TAG);

            float contactInfoHeight = 13;

            remainingContactDetails = contact.EmailAddresses.Count () + contact.PhoneNumbers.Count ();

            if (contact.EmailAddresses.Count > 0) {
                contactInfoHeight += AddEmailAddress (contact.EmailAddresses.FirstOrDefault (), contactInfoHeight, contactInfoScrollView, true);
            }

            if (contact.PhoneNumbers.Count > 0) {
                contactInfoHeight += AddPhoneNumber (contact.PhoneNumbers.FirstOrDefault (), contactInfoHeight, contactInfoScrollView, true);
            }

            if (contact.EmailAddresses.Count > 1) {
                bool skippedFirst = false;
                foreach (var emailAddressAttributes in contact.EmailAddresses) {
                    if (skippedFirst) {
                        contactInfoHeight += AddEmailAddress (emailAddressAttributes, contactInfoHeight, contactInfoScrollView, false);
                    }
                    skippedFirst = true;
                }
            }

            if (contact.PhoneNumbers.Count > 1) {
                bool skippedFirst = false;
                foreach (var phoneNumberAttribute in contact.PhoneNumbers) {
                    if (skippedFirst) {
                        contactInfoHeight += AddPhoneNumber (phoneNumberAttribute, contactInfoHeight, contactInfoScrollView, false);
                    }
                    skippedFirst = true;
                }
            }

            if (contactInfoHeight < contactInfoScrollView.Frame.Height) {
                SetViewHeight (contactInfoScrollView, contactInfoHeight);
            }
            contactInfoScrollView.ContentSize = new SizeF(contactInfoScrollView.Frame.Width, contactInfoHeight);

            //CONFIGURE INTERACTIONS VIEW
            UITableView interactionsTableView = (UITableView)View.ViewWithTag (INTERACTIONS_TABLE_VIEW_TAG);
            messageSource.owner = this;
            interactionsTableView.Source = messageSource;
            MultiSelectToggle (messageSource, false);
            SetEmailMessages (new UserInteractionEmailMessages (contact));

            // CONFIGURE NOTES VIEW
            var notesTextView = (UITextView)View.ViewWithTag (NOTES_TEXT_VIEW_TAG);

            McBody contactBody = McBody.QueryById<McBody> (contact.BodyId);
            if (null != contactBody) {
                notesTextView.Text = contactBody.GetContentsString ();
            }

            if (contact.Source != McAbstrItem.ItemSource.ActiveSync) {
                notesTextView.Text = "This contact has not been synced. Adding or editing notes is disabled.";
            }

            LayoutView ();
        }

        protected void SegmentedControlHandler (Object sender, EventArgs e)
        {
            UIView contactInfoScrollView = (UIView)View.ViewWithTag (CONTACT_INFO_VIEW_TAG);
            UITableView interactionsTableView = (UITableView)View.ViewWithTag (INTERACTIONS_TABLE_VIEW_TAG);
            UIView notesView = (UIView)View.ViewWithTag (NOTES_VIEW_TAG);

            selectedSegment = ((UISegmentedControl)sender).SelectedSegment;
            switch (selectedSegment) {
            case 0:
                editContact.Enabled = true;
                contactInfoScrollView.Hidden = false;
                interactionsTableView.Hidden = true;
                notesView.Hidden = true;
                break;
            case 1:
                editContact.Enabled = true;
                contactInfoScrollView.Hidden = true;
                interactionsTableView.Hidden = false;
                notesView.Hidden = true;
                RefreshData ();
                break;
            case 2:
                interactionsTableView.Hidden = true;
                contactInfoScrollView.Hidden = true;
                notesView.Hidden = false;
                if (contact.Source != McAbstrItem.ItemSource.ActiveSync) {
                    editContact.Enabled = false;
                } else {
                    editContact.Enabled = true;
                }
                break;
            default:
                NcAssert.CaseError ();
                break;
            }
            LayoutView ();
        }

        protected void ContactInfoTapHandler (bool isEmail, string contactInfo)
        {
            if (isEmail) {
                TouchedEmailButton (contactInfo);
            } else {
                TouchedCallButton (contactInfo);
            }
        }

        protected override void Cleanup ()
        {
            UIButton vipButton = (UIButton)View.ViewWithTag (HEADER_VIP_BUTTON_TAG);
            vipButton.TouchUpInside -= VipButtonTouchUpInside;
            vipButton = null;

            UIView callView = (UIView)View.ViewWithTag (HEADER_CALL_VIEW_TAG);
            headerCallViewGestureTapGesture.RemoveTarget (headerCallViewGestureTapGestureHandlerToken);
            callView.RemoveGestureRecognizer (headerCallViewGestureTapGesture);

            UIView emailView = (UIView)View.ViewWithTag (HEADER_EMAIL_VIEW_TAG);
            headerCallViewGestureTapGesture.RemoveTarget (headerEmailViewTapGestureHandlerToken);
            emailView.RemoveGestureRecognizer (headerEmailViewTapGesture);

            foreach (var v in tapGestures.ToList()) {
                UIView view;
                if (null == (view = View.ViewWithTag (v.viewTag))) {
                    break;
                }
                v.recognizer.RemoveTarget (v.token);
                view.RemoveFromSuperview ();
                tapGestures.Remove (v);
            }
            variableTransientTag = TRANSIENT_TAG_INITIAL_VALUE;

            editContact.Clicked -= EditButtonClicked;
            editContact = null;
        }

        protected void DefaultEmailTapHandler ()
        {
            //TODO: Use default
            TouchedEmailButton (contact.GetEmailAddress ());
        }

        protected void DefaultCallTapHandler ()
        {
            //TODO: Use default
            TouchedCallButton (contact.GetPhoneNumber ());
        }

        protected float AddEmailAddress (McContactEmailAddressAttribute email, float yOffset, UIView contactInfoScrollView, bool isFirstEmail) /*TODO Remove isFirstEmail once we're settings defaults */
        {
            remainingContactDetails--;
            UIView segmentedControllerHolderView = (UIView)View.ViewWithTag (SEGMENTED_VIEW_HOLDER_TAG);

            var emailView = new UIView (new RectangleF (0, yOffset, contactInfoScrollView.Frame.Width, 40));
            emailView.Tag = variableTransientTag;
            contactInfoScrollView.AddSubview (emailView);

            UIImageView emailIcon = new UIImageView (UIImage.FromBundle ("contacts-icn-email"));
            emailIcon.Frame = new RectangleF (0, 0, emailIcon.Frame.Width, emailIcon.Frame.Height);
            emailView.AddSubview (emailIcon);

            var emailLabel = new UILabel (new RectangleF (emailIcon.Frame.Right + 8, 0, 45, 15));
            emailLabel.Font = A.Font_AvenirNextMedium10;
            emailLabel.TextColor = UIColor.DarkGray;
            emailLabel.Text = "EMAIL";
            emailLabel.SizeToFit ();
            emailView.AddSubview (emailLabel);

            var emailComposeIcon = new UIImageView (UIImage.FromBundle ("contacts-email"));
            emailComposeIcon.Frame = new RectangleF (emailView.Frame.Width - emailComposeIcon.Frame.Width, 0, emailComposeIcon.Frame.Width, emailComposeIcon.Frame.Height);
            emailView.UserInteractionEnabled = true;
            emailView.AddSubview (emailComposeIcon);

            string canonicalEmail = McEmailAddress.QueryById <McEmailAddress> (email.EmailAddress).CanonicalEmailAddress;

            UITapGestureRecognizer emailTap = new UITapGestureRecognizer ();
            UITapGestureRecognizer.Token emailTapToken = emailTap.AddTarget (() => ContactInfoTapHandler (true, canonicalEmail));
            emailView.AddGestureRecognizer (emailTap);

            tapGestures.Add (new TapGesturePair (emailTap, emailTapToken, variableTransientTag));
            variableTransientTag++;

            if (isFirstEmail /*TODO email.IsDefault */) {
                UIImageView defaultEmailIcon = new UIImageView (UIImage.FromBundle ("contacts-marker"));
                defaultEmailIcon.Frame = new RectangleF (0, emailLabel.Frame.Bottom + 10, defaultEmailIcon.Frame.Width, defaultEmailIcon.Frame.Height);
                emailView.AddSubview (defaultEmailIcon);
            }

            var emailTextView = new UITextView (new RectangleF (emailLabel.Frame.X - 5, emailLabel.Frame.Bottom - 1, emailView.Frame.Width - 60, 30));
            emailTextView.Font = A.Font_AvenirNextMedium14;
            emailTextView.TextColor = A.Color_NachoGreen;
            emailTextView.Text = canonicalEmail;
            emailTextView.KeyboardType = UIKeyboardType.EmailAddress;
            emailTextView.UserInteractionEnabled = true;
            emailTextView.Editable = false;
            emailTextView.ScrollEnabled = false;
            emailTextView.SizeToFit ();
            emailView.AddSubview (emailTextView);

            if (remainingContactDetails > 0) {
                Util.AddHorizontalLine (emailLabel.Frame.X, emailTextView.Frame.Bottom + 10, segmentedControllerHolderView.Frame.Width - contactInfoScrollView.Frame.X - emailLabel.Frame.X, A.Color_NachoBorderGray, emailView);
                return emailTextView.Frame.Bottom + 10 + PADDING;
            } else {
                return emailTextView.Frame.Bottom + 10;
            }
        }

        protected float AddPhoneNumber (McContactStringAttribute phone, float yOffset, UIView contactInfoScrollView, bool isFirstPhone) /*TODO Remove isFirstEmail once we're settings defaults */
        {
            remainingContactDetails--;
            UIView segmentedControllerHolderView = (UIView)View.ViewWithTag (SEGMENTED_VIEW_HOLDER_TAG);

            var phoneView = new UIView (new RectangleF (0, yOffset, contactInfoScrollView.Frame.Width, 40));
            phoneView.Tag = variableTransientTag;
            phoneView.UserInteractionEnabled = true;
            contactInfoScrollView.AddSubview (phoneView);

            UIImageView phoneIcon = new UIImageView (UIImage.FromBundle ("contacts-icn-phone"));
            phoneIcon.Frame = new RectangleF (0, 0, phoneIcon.Frame.Width, phoneIcon.Frame.Height);

            phoneView.AddSubview (phoneIcon);

            string phoneLabelText = "";

            if (NachoCore.ActiveSync.Xml.Contacts.MobilePhoneNumber == phone.Name) {
                phoneLabelText = "MOBILE";
            } else if (NachoCore.ActiveSync.Xml.Contacts.BusinessPhoneNumber == phone.Name) {
                phoneLabelText = "BUSINESS";
            } else if (NachoCore.ActiveSync.Xml.Contacts.HomePhoneNumber == phone.Name) {
                phoneLabelText = "HOME";
            } else if (NachoCore.ActiveSync.Xml.Contacts.AssistantPhoneNumber == phone.Name) {
                phoneLabelText = "ASSISTANT";
            } else if (NachoCore.ActiveSync.Xml.Contacts.Business2PhoneNumber == phone.Name) {
                phoneLabelText = "SECOND BUSINESS";
            } else if (NachoCore.ActiveSync.Xml.Contacts.CarPhoneNumber == phone.Name) {
                phoneLabelText = "CAR";
            } else if (NachoCore.ActiveSync.Xml.Contacts.RadioPhoneNumber == phone.Name) {
                phoneLabelText = "RADIO";
            }else if (NachoCore.ActiveSync.Xml.Contacts.Home2PhoneNumber == phone.Name) {
                phoneLabelText = "SECOND HOME";
            } else {
                phoneLabelText = "PHONE";
            }

            var phoneLabel = new UILabel (new RectangleF (phoneIcon.Frame.Right + 8, 0, 45, 10));
            phoneLabel.Font = A.Font_AvenirNextMedium10;
            phoneLabel.TextColor = UIColor.DarkGray;
            phoneLabel.Text = phoneLabelText;
            phoneLabel.SizeToFit ();
            phoneView.AddSubview (phoneLabel);

            var callIcon = new UIImageView (UIImage.FromBundle ("contacts-call"));
            callIcon.Frame = new RectangleF (phoneView.Frame.Width - callIcon.Frame.Width, 0, callIcon.Frame.Width, callIcon.Frame.Height);
            phoneView.AddSubview (callIcon);

            UITapGestureRecognizer phoneTap = new UITapGestureRecognizer ();
            UITapGestureRecognizer.Token phoneTapToken = phoneTap.AddTarget (() => ContactInfoTapHandler (false, phone.Value));
            phoneView.AddGestureRecognizer (phoneTap);

            tapGestures.Add (new TapGesturePair (phoneTap, phoneTapToken, variableTransientTag));
            variableTransientTag++;

            if (isFirstPhone /*TODO phone.IsDefault */) {
                UIImageView defaultPhoneIcon = new UIImageView (UIImage.FromBundle ("contacts-marker"));
                defaultPhoneIcon.Frame = new RectangleF (0, phoneLabel.Frame.Bottom + 10, defaultPhoneIcon.Frame.Width, defaultPhoneIcon.Frame.Height);
                phoneView.AddSubview (defaultPhoneIcon);
            }

            var phoneNumberTextView = new UITextView (new RectangleF (phoneLabel.Frame.X - 5, phoneLabel.Frame.Bottom - 1, View.Frame.Width - 75, 16));
            phoneNumberTextView.Font = A.Font_AvenirNextMedium14;
            phoneNumberTextView.TextColor = A.Color_NachoGreen;
            phoneNumberTextView.Text = phone.Value;
            phoneNumberTextView.Editable = false;
            phoneNumberTextView.ScrollEnabled = false;
            phoneNumberTextView.SizeToFit ();
            phoneView.AddSubview (phoneNumberTextView);

            if (remainingContactDetails > 0) {
                Util.AddHorizontalLine (phoneLabel.Frame.X, phoneNumberTextView.Frame.Bottom + 10, segmentedControllerHolderView.Frame.Width - contactInfoScrollView.Frame.X - phoneLabel.Frame.X, A.Color_NachoBorderGray, phoneView);
                return phoneNumberTextView.Frame.Bottom + 10 + PADDING;
            } else {
                return phoneNumberTextView.Frame.Bottom + 10;
            }
        }

        public bool ShouldRecognizeSimultaneously (UIGestureRecognizer gestureRecognizer, UIGestureRecognizer otherGestureRecognizer)
        {
            return true;
        }

        public void TouchedQROption (string emailAddress)
        {
            if (string.IsNullOrEmpty (emailAddress)) {
                ComplainAbout ("No email address", "You've selected a contact who does not have an email address");
                return;
            }
            PerformSegue ("ContactToEmailCompose", new SegueHolder (emailAddress, true));
        }

        protected UIColor LighterColor (UIColor color)
        {
            float hue, saturation, brightness, alpha;
            color.GetHSBA (out hue, out saturation, out brightness, out alpha);
            return UIColor.FromHSBA (hue, saturation, Math.Min (brightness * 1.3f, 1.0f), alpha);
        }

        protected void SetViewHeight (UIView view, float height)
        {
            var frame = view.Frame;
            frame.Height = height;
            view.Frame = frame;
        }

        /// Return email address iff display name is set
        protected string GetTitleFromContact ()
        {
            var name = contact.GetDisplayName ();

            if (String.IsNullOrEmpty (name)) {
                return "";
            }
            var emailAddressAttribute = contact.EmailAddresses [0];
            var emailAddress = McEmailAddress.QueryById<McEmailAddress> (emailAddressAttribute.EmailAddress);
            return emailAddress.CanonicalEmailAddress;
        }

        protected void TouchedEmailButton (string address)
        {
            if (string.IsNullOrEmpty (address)) {
                ComplainAbout ("No email address", "You've selected a contact who does not have an email address");
                return;
            }
            PerformSegue ("ContactToEmailCompose", new SegueHolder (address));
        }

        protected void TouchedCallButton (string number)
        {
            if (string.IsNullOrEmpty (number)) {
                ComplainAbout ("No phone number", "You've selected a contact who does not have a phone number");
                return;
            }
            PerformAction ("tel", number);
        }

        protected void PerformAction (string action, string number)
        {
            UIApplication.SharedApplication.OpenUrl (new Uri (String.Format ("{0}:{1}", action, number)));
        }

        protected void ComplainAbout (string complaintTitle, string complaintMessage)
        {
            UIAlertView alert = new UIAlertView (complaintTitle, complaintMessage, null, "OK", null);
            alert.Show ();
        }

        protected void VipButtonTouchUpInside (object sender, EventArgs e)
        {
            contact.SetVIP (!contact.IsVip);
            UpdateVipButton ();
        }

        protected void UpdateVipButton ()
        {
            UIButton vipButton = (UIButton)View.ViewWithTag (HEADER_VIP_BUTTON_TAG);
            var vipImageName = (contact.IsVip ? "contacts-vip-checked" : "contacts-vip");

            using (var rawImage = UIImage.FromBundle (vipImageName)) {
                var image = rawImage.ImageWithRenderingMode (UIImageRenderingMode.AlwaysOriginal);
                vipButton.SetImage (image, UIControlState.Normal);
            }
        }

        ////////InteractionsTableViewStuff

        public void PerformSegueForDelegate (string identifier, NSObject sender)
        {
            PerformSegue (identifier, sender);
        }

        public void MessageThreadSelected (McEmailMessageThread messageThread)
        {
            PerformSegue ("NachoNowToMessageView", new SegueHolder (messageThread));
        }

        public void StatusIndicatorCallback (object sender, EventArgs e)
        {
            var s = (StatusIndEventArgs)e;
            if (NcResult.SubKindEnum.Info_EmailMessageSetChanged == s.Status.SubKind) {
                Log.Debug (Log.LOG_UI, "StatusIndicatorCallback");
                RefreshData ();
            }

            if (NcResult.SubKindEnum.Info_ContactSetChanged == s.Status.SubKind) {
                Log.Debug (Log.LOG_UI, "StatusIndicatorCallback: Contact Set Changed");
                RefreshData ();
            }
        }

        public void RefreshData ()
        {
            UITableView interactionsTableView = (UITableView)View.ViewWithTag (INTERACTIONS_TABLE_VIEW_TAG);

            NachoCore.Utils.NcAbate.HighPriority ("ContactDetailViewController RefreshData");
            messageSource.RefreshEmailMessages ();
            interactionsTableView.ReloadData ();
            NachoCore.Utils.NcAbate.RegularPriority ("ContactDetailViewController RefreshData");
        }

        public void DateSelected (MessageDeferralType request, McEmailMessageThread thread, DateTime selectedDate)
        {
            NcMessageDeferral.DeferThread (thread, request, selectedDate);
        }

        public void DismissChildDateController (INachoDateController vc)
        {
            vc.Setup (null, null, DateControllerType.None);
            vc.DimissDateController (false, new NSAction (delegate {
                this.DismissViewController (true, null);
            }));
        }

        public void DismissChildMessageEditor (INachoMessageEditor vc)
        {
            vc.SetOwner (null);
            vc.DismissMessageEditor (false, new NSAction (delegate {
                this.DismissViewController (true, null);
            }));
        }

        public void CreateTaskForEmailMessage (INachoMessageEditor vc, McEmailMessageThread thread)
        {
            var m = thread.SingleMessageSpecialCase ();
            var t = CalendarHelper.CreateTask (m);
            vc.SetOwner (null);
            vc.DismissMessageEditor (false, new NSAction (delegate {
                PerformSegue ("", new SegueHolder (t));
            }));
        }

        public void CreateMeetingEmailForMessage (INachoMessageEditor vc, McEmailMessageThread thread)
        {
            var m = thread.SingleMessageSpecialCase ();
            var c = CalendarHelper.CreateMeeting (m);
            vc.DismissMessageEditor (false, new NSAction (delegate {
                PerformSegue ("NachoNowToEditEvent", new SegueHolder (c));
            }));
        }

        public void DismissChildCalendarItemEditor (INachoCalendarItemEditor vc)
        {
            vc.SetOwner (null);
            vc.DismissCalendarItemEditor (true, null);
        }

        public void DismissChildFolderChooser (INachoFolderChooser vc)
        {
            vc.SetOwner (null, false, null);
            vc.DismissFolderChooser (false, null);
        }

        public void FolderSelected (INachoFolderChooser vc, McFolder folder, object cookie)
        {
            if (null != messageSource) {
                messageSource.FolderSelected (vc, folder, cookie);
            }
            vc.DismissFolderChooser (true, null);
        }

        public void MultiSelectToggle (MessageTableViewSource source, bool enabled)
        {
            return;
        }

        public void SetEmailMessages (INachoEmailMessages messageThreads)
        {
            this.messageSource.SetEmailMessages (messageThreads);
        }

        public void SaveNote (int accountId, string noteText)
        {
            if (null != contact) {
                McBody contactBody = McBody.QueryById<McBody> (contact.BodyId);
                if (null != contactBody) {
                    contactBody.UpdateData (noteText);
                } else {
                    contact.BodyId = McBody.InsertFile (accountId, McAbstrFileDesc.BodyTypeEnum.PlainText_1, noteText).Id;
                }

                contact.Update ();
                NachoCore.BackEnd.Instance.UpdateContactCmd (contact.AccountId, contact.Id);
            }
        }

        public string GetNoteText ()
        {
            NcAssert.True (null != contact);

            if (contact.Source != McAbstrItem.ItemSource.ActiveSync) {
                return "This contact has not been synced. Adding or editing notes is disabled.";
            } else {
                McBody contactBody = McBody.QueryById<McBody> (contact.BodyId);
                if (null != contactBody) {
                    return contactBody.GetContentsString ();
                }
                return "";
            }
        }
    }
}
