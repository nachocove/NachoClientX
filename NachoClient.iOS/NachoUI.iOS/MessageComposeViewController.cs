// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using System.Text;
using CoreGraphics;
using Foundation;
using UIKit;

using MimeKit;

using NachoCore;
using NachoCore.Brain;
using NachoCore.Model;
using NachoCore.Utils;

using WebKit;

namespace NachoClient.iOS
{

    public interface MessageComposeViewDelegate {

        void MessageComposeViewDidBeginSend (MessageComposeViewController vc);
        void MessageComposeViewDidSaveDraft (MessageComposeViewController vc);
        void MessageComposeViewDidCancel (MessageComposeViewController vc);

    }

    public partial class MessageComposeViewController : NcUIViewController,
        IWKNavigationDelegate,
        MessageComposeHeaderViewDelegate,
        QuickResponseViewControllerDelegate,
        INachoIntentChooserParent,
        INachoDateControllerParent,
        INachoFileChooserParent,
        INachoContactChooserDelegate
    {

        #region Properties

        public MessageComposeViewDelegate ComposeDelegate;
        public bool StartWithQuickResponse;
        public EmailHelper.Action MessageKind = EmailHelper.Action.Send;
        public McEmailMessageThread RelatedThread;
        public McCalendar RelatedCalendarItem;
        public McEmailMessage Message;
        public MimeMessage MimeMessage;
        public string InitialText;
        public List<McAttachment> InitialAttachments;
        CompoundScrollView ScrollView;
        MessageComposeHeaderView HeaderView;
        WKWebView WebView;
        McAccount Account;
        NcUIBarButtonItem CloseButton;
        NcUIBarButtonItem SendButton;
        NcUIBarButtonItem QuickResponseButton;
        UIAlertController CloseAlertController;
        bool HasShownOnce;
        UIStoryboard mainStorybaord;
        UIStoryboard MainStoryboard {
            get {
                if (mainStorybaord == null) {
                    mainStorybaord = UIStoryboard.FromName ("MainStoryboard_iPhone", null);
                }
                return mainStorybaord;
            }
        }

        enum MessagePreparationStatus {
            NotStarted,
            Preparing,
            Done
        };

        MessagePreparationStatus MessagePreparationState = MessagePreparationStatus.NotStarted;

        NSObject BackgroundNotification;
        NSObject ContentSizeCategoryChangedNotification;

        protected static readonly long EMAIL_SIZE_ALERT_LIMIT = 2000000;

        #endregion

        #region Constructors

        public MessageComposeViewController () : base ()
        {
            Account = NcApplication.Instance.Account;
        }

        #endregion

        #region Presenters

        public void Present (Action completionHandler = null)
        {
            var window = UIApplication.SharedApplication.Delegate.GetWindow ();
            var navigationController = new UINavigationController (this);
            NachoClient.Util.ConfigureNavBar (false, navigationController);
            window.RootViewController.PresentViewController (navigationController, true, completionHandler);
        }

        #endregion

        #region View Lifecycle

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();

            View.BackgroundColor = UIColor.White;

            // Nav bar
            CloseButton = new NcUIBarButtonItem ();
            Util.SetAutomaticImageForButton (CloseButton, "icn-close");
            CloseButton.AccessibilityLabel = "Close";
            CloseButton.Clicked += Close;

            SendButton = new NcUIBarButtonItem ();
            Util.SetAutomaticImageForButton (SendButton, "icn-send");
            SendButton.AccessibilityLabel = "Send";
            SendButton.Clicked += Send;

            QuickResponseButton = new NcUIBarButtonItem ();
            Util.SetAutomaticImageForButton (QuickResponseButton, "contact-quickemail");
            QuickResponseButton.AccessibilityLabel = "Quick response";
            QuickResponseButton.Clicked += QuickReply;

            NavigationItem.LeftBarButtonItem = CloseButton;
            NavigationItem.RightBarButtonItems = new UIBarButtonItem[] {
                SendButton,
                QuickResponseButton,
            };

            // Content Area
            ScrollView = new CompoundScrollView (View.Bounds);
            ScrollView.AutoresizingMask = UIViewAutoresizing.FlexibleWidth | UIViewAutoresizing.FlexibleHeight;
            ScrollView.AlwaysBounceVertical = true;

            HeaderView = new MessageComposeHeaderView (ScrollView.Bounds);
            HeaderView.Frame = new CGRect (0.0, 0.0, ScrollView.Bounds.Width, HeaderView.PreferredHeight);
            HeaderView.HeaderDelegate = this;
            HeaderView.AttachmentsAllowed = RelatedCalendarItem == null;

            var config = new WKWebViewConfiguration ();
            config.SuppressesIncrementalRendering = true;
            WebView = new WKWebView (ScrollView.Bounds, config);
            WebView.NavigationDelegate = this;

            ScrollView.AddCompoundView (HeaderView);
            ScrollView.AddCompoundView (WebView);
            View.AddSubview (ScrollView);
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);

            StartPreparingMessage ();

            RegisterForNotifications ();

            if (null != RelatedThread) {
                var now = DateTime.UtcNow;
                var message = RelatedThread.FirstMessageSpecialCase ();
                NcBrain.MessageReplyStatusUpdated (message, now, 0.1);
            }

            if (!HasShownOnce) {
                if (StartWithQuickResponse) {
                    ShowQuickResponses ();
                }
                HasShownOnce = true;
            }

        }

        public override void ViewDidAppear (bool animated)
        {
            base.ViewDidAppear (animated);
        }

        public override void ViewWillDisappear (bool animated)
        {
            base.ViewWillDisappear (animated);
            UnregisterNotifications ();
        }

        public override void ViewDidDisappear (bool animated)
        {
            base.ViewDidDisappear (animated);
        }

        #endregion

        #region Layout

        private void UpdateScrollViewSize ()
        {
            CGSize contentSize = new CGSize (ScrollView.Bounds.Width, 0);
            contentSize.Height += HeaderView.Frame.Height;
            contentSize.Height += WebView.ScrollView.ContentSize.Height;
            if (WebView.ScrollView.ContentSize.Width > contentSize.Width) {
                contentSize.Width = WebView.ScrollView.ContentSize.Width;
            }
            ScrollView.ContentSize = contentSize;
        }

        private void LayoutScrollView ()
        {
            UpdateScrollViewSize ();
            ScrollView.SetNeedsLayout ();
            ScrollView.LayoutIfNeeded ();
        }

        public void MessageComposeHeaderViewDidChangeHeight (MessageComposeHeaderView view)
        {
            LayoutScrollView ();
        }

        protected override void OnKeyboardChanged ()
        {
            var frame = View.Bounds;
            frame.Height = frame.Height - keyboardHeight;
            ScrollView.Frame = frame;
        }

        #endregion

        #region User Actions - Navbar

        // User hitting the send button
        public void Send (object sender, EventArgs e)
        {
            View.EndEditing (true);
            // TODO: send (can happen in background)
            if (ComposeDelegate != null) {
                ComposeDelegate.MessageComposeViewDidBeginSend (this);
            }
            DismissViewController (true, null);
        }

        // User hitting the quick reply button
        public void QuickReply (object sender, EventArgs e)
        {
            View.EndEditing (true);
            ShowQuickResponses ();
        }

        // User hitting the close button
        public void Close (object sender, EventArgs e)
        {
            View.EndEditing (true);
            CloseAlertController = UIAlertController.Create (null, null, UIAlertControllerStyle.ActionSheet);
            CloseAlertController.AddAction (UIAlertAction.Create ("Discard Draft", UIAlertActionStyle.Destructive, Discard));
            CloseAlertController.AddAction (UIAlertAction.Create ("Save Draft", UIAlertActionStyle.Default, Save));
            CloseAlertController.AddAction (UIAlertAction.Create ("Cancel", UIAlertActionStyle.Cancel, (UIAlertAction obj) => { CloseAlertController = null; }));
            PresentViewController (CloseAlertController, true, null);
        }

        // User opting to discard while closing
        public void Discard (UIAlertAction obj)
        {
            CloseAlertController = null;
            // TODO: delete message (can happen in background)
            if (ComposeDelegate != null) {
                ComposeDelegate.MessageComposeViewDidCancel (this);
            }
            DismissViewController (true, null);
        }

        // User opting to save while closing
        public void Save (UIAlertAction obj)
        {
            CloseAlertController = null;
            // TODO: save message (can happen in background)
            if (ComposeDelegate != null) {
                ComposeDelegate.MessageComposeViewDidCancel (this);
            }
            DismissViewController (true, null);
        }

        // User selecting a quick response
        public void QuickResponseViewDidSelectResponse (QuickResponseViewController vc, NcQuickResponse.QRTypeEnum whatType, NcQuickResponse.QuickResponse response, McEmailMessage.IntentType intentType)
        {
            if (whatType == NcQuickResponse.QRTypeEnum.Compose) {
                Message.Subject = response.subject;
                // TODO: update header view
            }
            if (MessagePreparationState == MessagePreparationStatus.Done) {
            } else {
                InitialText = response.body;
            }
//            if (NcQuickResponse.QRTypeEnum.Compose == whichType) {
//                alwaysShowIntent = true;
//                subjectField.Text = selectedResponse.subject;
//            }
//
//            var attributes = new CoreText.CTStringAttributes ();
//            attributes.Font = new CoreText.CTFont (composeFont.Name, composeFont.PointSize);
//
//            var response = new NSMutableAttributedString (selectedResponse.body, attributes);
//            response.Append (bodyTextView.AttributedText);
//            bodyTextView.AttributedText = response;
//
//            bodyTextView.BecomeFirstResponder ();
//            if (bodyTextView.Text.Contains ("\n")) {
//                bodyTextView.SelectedRange = new NSRange (bodyTextView.Text.IndexOf ("\n"), 0);
//            }


//            this.messageIntent = intent;
//            this.messageIntentDateType = intentDateType;
//            this.messageIntentDateTime = intentDateTime;
//            intentDisplayLabel.Text = NcMessageIntent.GetIntentString (intent, intentDateType, intentDateTime);
        }

        #endregion

        #region User Actions - Header

        // User selecting + button in To/CC/BCC field
        public void MessageComposeHeaderViewDidSelectContactChooser (MessageComposeHeaderView view, NcEmailAddress address)
        {
            ContactChooserViewController chooserController = MainStoryboard.InstantiateViewController ("ContactChooserViewController") as ContactChooserViewController;
            chooserController.SetOwner (this, Account, address, NachoContactType.EmailRequired);
            FadeCustomSegue.Transition (this, chooserController);
        }

        // User starting to type in To/CC/BCC field
        public void MessageComposeHeaderViewDidSelectContactSearch (MessageComposeHeaderView view, NcEmailAddress address)
        {
            ContactSearchViewController searchController = MainStoryboard.InstantiateViewController ("ContactSearchViewController") as ContactSearchViewController;
            searchController.SetOwner (this, Account, address, NachoContactType.EmailRequired);
            FadeCustomSegue.Transition (this, searchController);
        }

        // User selecting contact for To/CC/BCC field
        public void UpdateEmailAddress (INachoContactChooser vc, NcEmailAddress address)
        {
            if (address.kind == NcEmailAddress.Kind.To) {
                HeaderView.ToView.Append (address);
                Message.To = EmailHelper.AddressStringFromList (HeaderView.ToView.AddressList);
            } else if (address.kind == NcEmailAddress.Kind.Cc) {
                HeaderView.CcView.Append (address);
                Message.Cc = EmailHelper.AddressStringFromList (HeaderView.CcView.AddressList);
            } else if (address.kind == NcEmailAddress.Kind.Bcc) {
                HeaderView.BccView.Append (address);
                Message.Bcc = EmailHelper.AddressStringFromList (HeaderView.BccView.AddressList);
            } else {
                NcAssert.CaseError ();
            }
        }

        public void MessageComposeHeaderViewDidRemoveAddress (MessageComposeHeaderView view, NcEmailAddress address)
        {
            
            if (address.kind == NcEmailAddress.Kind.To) {
                Message.To = EmailHelper.AddressStringFromList (HeaderView.ToView.AddressList);
            } else if (address.kind == NcEmailAddress.Kind.Cc) {
                Message.Cc = EmailHelper.AddressStringFromList (HeaderView.CcView.AddressList);
            } else if (address.kind == NcEmailAddress.Kind.Bcc) {
                Message.Bcc = EmailHelper.AddressStringFromList (HeaderView.BccView.AddressList);
            } else {
                NcAssert.CaseError ();
            }
        }

        // ??
        public void DeleteEmailAddress (INachoContactChooser vc, NcEmailAddress address)
        {
            // old implementation did nothing
        }

        // User changing the subject
        public void MessageComposeHeaderViewDidChangeSubject (MessageComposeHeaderView view, string subject)
        {
            Message.Subject = subject;
        }

        // User tapping the intent field 
        public void MessageComposeHeaderViewDidSelectIntentField (MessageComposeHeaderView view)
        {
            IntentSelectionViewController intentController = MainStoryboard.InstantiateViewController ("IntentSelectionViewController") as IntentSelectionViewController;
            intentController.ModalTransitionStyle = UIModalTransitionStyle.CrossDissolve;
            intentController.SetOwner (this);
            intentController.SetDateControllerOwner (this);
            PresentViewController (intentController, true, null);
        }

        // User selecting an intent
        public void SelectMessageIntent (NcMessageIntent.MessageIntent intent)
        {
            Message.Intent = intent.type;
            Message.IntentDateType = MessageDeferralType.None;
            Message.IntentDate = DateTime.MinValue;
            UpdateHeaderViewIntent ();
        }

        // User selecting a date for the intent
        public void DateSelected (NcMessageDeferral.MessageDateType type, MessageDeferralType request, McEmailMessageThread thread, DateTime selectedDate)
        {
            Message.IntentDateType = request;
            Message.IntentDate = selectedDate;
            UpdateHeaderViewIntent ();
        }
            
        // User tapping on add attachment
        public void MessageComposeHeaderViewDidSelectAddAttachment (MessageComposeHeaderView view)
        {
            AddAttachmentViewController attachmentViewController = MainStoryboard.InstantiateViewController ("AddAttachmentViewController") as AddAttachmentViewController;
            attachmentViewController.ModalTransitionStyle = UIModalTransitionStyle.CrossDissolve;
            attachmentViewController.SetOwner (this, Account);
            PresentViewController (attachmentViewController, true, null);
        }

        // User tapping on a specific attachment to display
        public void MessageComposeHeaderViewDidSelectAttachment (MessageComposeHeaderView view, McAttachment attachment)
        {
            PlatformHelpers.DisplayAttachment (this, attachment);
        }

        // User picking a file as an attachment
        public void SelectFile (INachoFileChooser vc, McAbstrObject obj)
        {
            var attachment = obj as McAttachment;
            if (attachment != null) {
                attachment = AttachmentHelper.CopyAttachment (attachment);
            }else{
                var file = obj as McDocument;
                if (file != null) {
                    attachment = McAttachment.InsertSaveStart (Account.Id);
                    attachment.SetDisplayName (file.DisplayName);
                    attachment.IsInline = true;
                    attachment.UpdateFileCopy (file.GetFilePath ());
                } else {
                    var note = obj as McNote;
                    if (note != null) {
                        attachment = McAttachment.InsertSaveStart (Account.Id);
                        attachment.SetDisplayName (note.DisplayName + ".txt");
                        attachment.IsInline = true;
                        attachment.UpdateData (note.noteContent);
                    }
                }
            }

            if (attachment != null) {
                attachment.ItemId = Message.Id;
                HeaderView.AttachmentsView.Append (attachment);
                this.DismissViewController (true, null);
            } else {
                NcAssert.CaseError ();
            }

        }

        // User deleting an attachment
        public void MessageComposeHeaderViewDidRemoveAttachment (MessageComposeHeaderView view, McAttachment attachment)
        {
            attachment.Delete ();
        }

        // User adding an attachment from media browser
        public void Append (McAttachment attachment)
        {
            attachment.ItemId = Message.Id;
            HeaderView.AttachmentsView.Append (attachment);
        }

        // Not really a direct user action, but caused by the user selecting a date for the intent
        public void DismissChildDateController (INachoDateController vc)
        {
            // Basically, once the intent date view controller is dismissed, we need to dismiss the intent controller
            DismissViewController (false, null);
        }

        // Not really a direct user action, but caused by the user selecting a date for the intent
        public void DismissChildFileChooser (INachoFileChooser vc)
        {
            DismissViewController (true, null);
        }

        // Not really a direct user action, but caused by the user selecting a date for the intent
        public void DismissPhotoPicker ()
        {
            DismissViewController (true, null);
        }

        // Not really a direct user action, but caused by the user selecting a contact
        public void DismissINachoContactChooser (INachoContactChooser vc)
        {
            // The contact chooser was pushed on the nav stack, rather than shown as a modal.
            // So we need to pop it from the stack
            vc.Cleanup ();
            NavigationController.PopViewController (true);
        }

        #endregion

        #region Message Preparation

        private void StartPreparingMessage ()
        {
            if (MessagePreparationState != MessagePreparationStatus.NotStarted) {
                return;
            }
            MessagePreparationState = MessagePreparationStatus.Preparing;
            if (Message == null) {
                Message = McEmailMessage.MessageWithSubject (Account, "");
            }
            if (Message.Id == 0) {
                if (InitialText == null) {
                    InitialText = "";
                }
                if (!String.IsNullOrEmpty (Account.Signature)) {
                    InitialText += "\n\n" + Account.Signature;
                }
                if (RelatedThread != null) {
                    var message = RelatedThread.FirstMessageSpecialCase ();
                }
                if (!String.IsNullOrWhiteSpace (InitialText)) {
                }
                if (InitialAttachments != null) {
                    CopyInitialAttachments ();
                }
            } else {
                MessagePreparationState = MessagePreparationStatus.Done;
            }

            UpdateHeaderView ();

            // Fake web view load for testing layout
            NSUrl url = new NSUrl("http://www.nytimes.com");
            NSUrlRequest request = new NSUrlRequest (url);
            WebView.LoadRequest (request);
        }

        private void CopyInitialAttachments ()
        {
            //                AttachmentHelper.CopyAttachment (attachment)
        }

        #endregion

        #region Web View Delegate

        [Export ("webView:didFinishNavigation:")]
        public void DidFinishNavigation (WebKit.WKWebView webView, WebKit.WKNavigation navigation)
        {
            // The navigation is done, meaning the HTML has loaded in the web view, so we now have to
            // tell our scroll view how big the webview is.
            // Unfortunately, WebView.ScrollView.ContentSize.Height is still 0 at this point.
            // It's a timing issue, and so we'll wait until it's not 0
            UpdateScrollViewSizeOnceWebViewIsSized ();
        }

        [Export ("updateScrollViewSizeOnceWebViewIsSized")]
        private void UpdateScrollViewSizeOnceWebViewIsSized ()
        {
            // The basic idea is to keep scheduling ourselves in the run loop until we see a non-zero height.
            // Using the run loop is crucuial because it means we won't block anything.
            // Experiements show this usually takes anywhere from 1-4 itereations.
            if (WebView.ScrollView.ContentSize.Height == 0.0) {
                var selector = new ObjCRuntime.Selector ("updateScrollViewSizeOnceWebViewIsSized");
                var timer = NSTimer.CreateTimer (0.0, this, selector, null, false);
                NSRunLoop.Main.AddTimer (timer, NSRunLoopMode.Default);
            } else {
                UpdateScrollViewSize ();
            }
        }

        #endregion

        #region Helpers

        private void ShowQuickResponses (bool animated = true)
        {
            NcQuickResponse.QRTypeEnum responseType = NcQuickResponse.QRTypeEnum.Compose;

            if (EmailHelper.IsReplyAction (MessageKind)) {
                responseType = NcQuickResponse.QRTypeEnum.Reply;
            } else if (EmailHelper.IsForwardAction (MessageKind)) {
                responseType = NcQuickResponse.QRTypeEnum.Forward;
            }

            var quickViewController = new QuickResponseViewController ();
            quickViewController.SetProperties (responseType);
            PresentViewController (quickViewController, animated, null);
        }

        #endregion

        #region Header View

        private void UpdateHeaderView ()
        {
            UpdateHeaderSubjectView ();
            UpdateHeaderViewIntent ();
            var attachments = McAttachment.QueryByItemId (Message);
            foreach (var attachment in attachments) {
                HeaderView.AttachmentsView.Append (attachment);
            }
        }

        private void UpdateHeaderSubjectView ()
        {
            HeaderView.SubjectField.Text = Message.Subject;
        }

        private void UpdateHeaderViewIntent ()
        {
            HeaderView.IntentView.ValueLabel.Text = NcMessageIntent.GetIntentString (Message.Intent, Message.IntentDateType, Message.IntentDate);
        }

        #endregion

        #region Notifications

        private void RegisterForNotifications ()
        {
            BackgroundNotification = NSNotificationCenter.DefaultCenter.AddObserver (UIApplication.DidEnterBackgroundNotification, OnBackgroundNotification);
            ContentSizeCategoryChangedNotification = NSNotificationCenter.DefaultCenter.AddObserver (UIApplication.ContentSizeCategoryChangedNotification, OnContentSizeCategoryChangedNotification);
        }

        private void UnregisterNotifications ()
        {
            NSNotificationCenter.DefaultCenter.RemoveObserver (BackgroundNotification);
            NSNotificationCenter.DefaultCenter.RemoveObserver (ContentSizeCategoryChangedNotification);
        }

        private void OnBackgroundNotification (NSNotification notification)
        {
            if (null != CloseAlertController) {
                CloseAlertController.DismissViewController (false, null);
            }
        }

        void OnContentSizeCategoryChangedNotification (NSNotification notification)
        {
            // TODO: can we do anything to update the webview font size?
        }

        #endregion

        public override bool ShouldEndEditing {
            get {
                return false;
            }
        }
    }
        
}
