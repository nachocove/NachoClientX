// This file has been autogenerated from a class added in the UI designer.

using System;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using System.Collections.Generic;
using SWRevealViewControllerBinding;
using NachoCore.Model;

namespace NachoClient.iOS
{
    public partial class SidebarViewController : UITableViewController
    {
        ///   cellIDs for segues
        ///      "SidebarToAccounts"
        ///      "SidebarToCalendar"
        ///      "SidebarToContacts"
        ///      "SidebarToFolders"
        ///      "SidebarToSettings"
        ///      "SidebarToMessages"
     
        class SidebarMenu
        {
            public int Indent;
            public string SegueName;
            public string DisplayName;
            public NcFolder Folder;
            public bool isDeviceContactsKludge;
            public bool isDeviceCalendarKludge;

            public SidebarMenu (NcFolder folder, string displayName, string segueName)
            {
                Indent = 0;
                SegueName = segueName;
                DisplayName = displayName;
                Folder = folder;
                isDeviceContactsKludge = false;
                isDeviceCalendarKludge = false;
            }
        };

        List<SidebarMenu> menu;
        NachoFolders email;
        NachoFolders contacts;
        NachoFolders calendars;

        const string SidebarToFolderSegueId = "SidebarToFolder";
        const string SidebarToFoldersSegueId = "SidebarToFolders";
        const string SidebarToContactsSegueId = "SidebarToContacts";
        const string SidebarToCalendarSegueId = "SidebarToCalendar";
        const string SidebarToMessagesSegueId = "SidebarToMessages";


        public SidebarViewController (IntPtr handle) : base (handle)
        {
        }

        /// <summary>
        /// Update the list of folders when we appear
        /// </summary>
        /// <param name="animated">If set to <c>true</c> animated.</param>
        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);

            menu = new List<SidebarMenu> ();

            email = new NachoFolders (NachoFolders.FilterForEmail);
            contacts = new NachoFolders (NachoFolders.FilterForContacts);
            calendars = new NachoFolders (NachoFolders.FilterForCalendars);

            menu.Add (new SidebarMenu (null, "Folders", SidebarToFoldersSegueId));

            for (int i = 0; i < email.Count (); i++) {
                NcFolder f = email.GetFolder (i);
                var m = new SidebarMenu (f, f.DisplayName, SidebarToMessagesSegueId);
                m.Indent = 1;
                menu.Add (m);
            }

            menu.Add (new SidebarMenu (null, "Contacts", SidebarToContactsSegueId));
            for (int i = 0; i < contacts.Count (); i++) {
                NcFolder f = contacts.GetFolder (i);
                var m = new SidebarMenu (f, f.DisplayName, SidebarToContactsSegueId);
                m.Indent = 1;
                menu.Add (m);
            }
            var deviceContacts = new SidebarMenu (null, "Device Contacts", SidebarToContactsSegueId);
            deviceContacts.isDeviceContactsKludge = true;
            menu.Add (deviceContacts);

            menu.Add (new SidebarMenu (null, "Calendars", SidebarToCalendarSegueId));
            for (int i = 0; i < calendars.Count (); i++) {
                NcFolder f = calendars.GetFolder (i);
                var m = new SidebarMenu (f, f.DisplayName, SidebarToCalendarSegueId);
                m.Indent = 1;
                menu.Add (m);
            }
            var deviceCalendar = new SidebarMenu (null, "Device Calendar", SidebarToCalendarSegueId);
            deviceCalendar.isDeviceCalendarKludge = true;
            menu.Add (deviceCalendar);

            menu.Add (new SidebarMenu (null, "Accounts", "SidebarToAccounts"));
            menu.Add (new SidebarMenu (null, "Settings", "SidebarToSettings"));

            TableView.ReloadData ();
        }

        public override void PrepareForSegue (UIStoryboardSegue segue, NSObject sender)
        {
            Console.WriteLine ("PrepareForSegue: {0}", segue.Identifier);

            NSIndexPath indexPath = this.TableView.IndexPathForSelectedRow;
            UIViewController destViewController = (UIViewController)segue.DestinationViewController;

            SidebarMenu m = menu [indexPath.Row];

            destViewController.Title = m.DisplayName;

            switch (segue.Identifier) {
            case SidebarToContactsSegueId:
                {
                    ContactsViewController vc = (ContactsViewController)destViewController;
                    vc.UseDeviceContacts = m.isDeviceContactsKludge;
                }
                break;
            case SidebarToCalendarSegueId:
                {
                    CalendarViewController vc = (CalendarViewController)destViewController;
                    vc.UseDeviceCalendar = m.isDeviceCalendarKludge;
                }
                break;
            case SidebarToMessagesSegueId:
                {
                    MessageViewController vc = (MessageViewController)destViewController;
                    vc.SetFolder (m.Folder);
                }
                break;
            }

            if (segue.GetType () == typeof(SWRevealViewControllerSegue)) {
                Console.WriteLine ("PrepareForSqueue: SWRevealViewControllerSegue");
                SWRevealViewControllerSegue swSegue = (SWRevealViewControllerSegue)segue;
                swSegue.PerformBlock = PerformBlock;
            }
        }

        /// <summary>
        /// Started from PrepareForSegue
        /// </summary>
        public void PerformBlock (SWRevealViewControllerSegue s, UIViewController svc, UIViewController dvc)
        {
            Console.WriteLine ("PrepareForSegue: PerformBlock");
            UINavigationController navController = (UINavigationController)this.RevealViewController ().FrontViewController;
            navController.SetViewControllers (new UIViewController[] { dvc }, true);
            this.RevealViewController ().SetFrontViewPosition (FrontViewPosition.Left, true);
        }

        /// <summary>
        /// Called by the TableView to determine how many sections(groups) there are.
        /// </summary>
        public override int NumberOfSections (UITableView tableView)
        {
            return 1;
        }

        /// <summary>
        /// Called by the TableView to determine how many cells to create for that particular section.
        /// </summary>
        public override int RowsInSection (UITableView tableview, int section)
        {
            return menu.Count;
        }

        /// <summary>
        /// Called by the TableView to get the actual UITableViewCell to render for the particular row
        /// </summary>
        public override UITableViewCell GetCell (UITableView tableView, MonoTouch.Foundation.NSIndexPath indexPath)
        {
            // TODO: Highlight folders
            var m = menu [indexPath.Row];
            UITableViewCell cell = tableView.DequeueReusableCell (m.SegueName);
            System.Diagnostics.Trace.Assert (null != cell);
            cell.TextLabel.Text = m.DisplayName;
            return cell;
        }
    }
}
