// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Drawing;
using System.Collections.Generic;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using UIImageEffectsBinding;
using MonoTouch.CoreGraphics;
using NachoCore.Brain;
using NachoCore.Model;
using NachoCore.ActiveSync;
using NachoCore.Utils;

namespace NachoClient.iOS
{
    public partial class LabelSelectionViewController : NcUIViewControllerNoLeaks
    {
        protected const float X_INDENT = 30;

        protected List<PhoneLabel> phoneLabels = new List<PhoneLabel> ();
        public PhoneLabel selectedPhoneLabel;
        protected McContact contact;

        protected const int SELECTED_BUTTON_IMAGE_TAG = 88;
        protected const int NOT_SELECTED_BUTTON_IMAGE_TAG = 99;

        protected const int SELECTION_BUTTON_STARTING_TAG = 1000;

        protected int selectedButtonTag = SELECTION_BUTTON_STARTING_TAG;

        public ContactDefaultSelectionViewController owner;

        UIBarButtonItem DismissButton;

        public LabelSelectionViewController (IntPtr handle) : base (handle)
        {

        }

        public override void ViewDidLoad ()
        {
            CreateLabelList ();
            base.ViewDidLoad ();
        }

        protected override void CreateViewHierarchy ()
        {
            View.BackgroundColor = A.Color_NachoGreen;

            var navBar = new UINavigationBar (new RectangleF (0, 20, View.Frame.Width, 44));
            navBar.BarStyle = UIBarStyle.Default;
            navBar.Opaque = true;
            navBar.Translucent = false;

            var navItem = new UINavigationItem ("Choose a Label");
            using (var image = UIImage.FromBundle ("modal-close")) {
                DismissButton = new UIBarButtonItem (image, UIBarButtonItemStyle.Plain, null);
                DismissButton.Clicked += DismissViewTouchUpInside;
                navItem.LeftBarButtonItem = DismissButton;
            }
            navBar.Items = new UINavigationItem[] { navItem };

            View.AddSubview (navBar);
            float yOffset = 64;

            Util.AddHorizontalLine (0, yOffset, View.Frame.Width, UIColor.LightGray, View);
            yOffset += 1;

            int i = 0;
            foreach (var p in phoneLabels) {
                ListSelectionButton selectionButton = new ListSelectionButton (p.label, SELECTION_BUTTON_STARTING_TAG + i);
                UIButton button = selectionButton.GetButton (View, yOffset);
                button.TouchUpInside += SelectionButtonClicked;
                View.AddSubview (button);
                if (0 == i) {
                    button.SendActionForControlEvents (UIControlEvent.TouchUpInside);
                }
                yOffset += 58;
                Util.AddHorizontalLine (80, yOffset, View.Frame.Width - 80, UIColor.LightGray, View);
                yOffset += 1;
                i++;
            }
        }

        protected void SelectionButtonClicked (object sender, EventArgs e)
        {
            UIButton previouslySelectedButton = (UIButton)View.ViewWithTag (selectedButtonTag);
            UIImageView previouslySelectedButtonSelectedImageView = (UIImageView)previouslySelectedButton.ViewWithTag (SELECTED_BUTTON_IMAGE_TAG);
            UIImageView previouslySelectedButtonNotSelectedImageView = (UIImageView)previouslySelectedButton.ViewWithTag (NOT_SELECTED_BUTTON_IMAGE_TAG);
            previouslySelectedButtonSelectedImageView.Hidden = true;
            previouslySelectedButtonNotSelectedImageView.Hidden = false;

            UIButton selectedButton = (UIButton)sender;
            UIImageView selectedButtonSelectedImageView = (UIImageView)selectedButton.ViewWithTag (SELECTED_BUTTON_IMAGE_TAG);
            UIImageView selectedButtonNotSelectedImageView = (UIImageView)selectedButton.ViewWithTag (NOT_SELECTED_BUTTON_IMAGE_TAG);
            selectedButtonSelectedImageView.Hidden = false;
            selectedButtonNotSelectedImageView.Hidden = true;

            selectedButtonTag = selectedButton.Tag;
            selectedPhoneLabel = phoneLabels [selectedButtonTag - 1000];
        }

        public class PhoneLabel
        {
            public string type;
            public string label;

            public PhoneLabel (string type, string label)
            {
                this.type = type;
                this.label = label;
            }
        }

        public class ListSelectionButton
        {
            protected string label;
            protected int tag;

            public ListSelectionButton (string label, int tag)
            {
                this.label = label;
                this.tag = tag;
            }

            public UIButton GetButton (UIView parentView, float yOffset)
            {
                UIButton selectionButton = new UIButton (new RectangleF (0, yOffset, parentView.Frame.Width, 58));
                selectionButton.Tag = tag;
                selectionButton.BackgroundColor = A.Color_NachoGreen;

                UIImageView buttonSelectedImageView = new UIImageView (UIImage.FromBundle ("modal-checkbox-checked"));
                buttonSelectedImageView.Frame = new RectangleF (30, 18, buttonSelectedImageView.Frame.Width, buttonSelectedImageView.Frame.Height);
                buttonSelectedImageView.Tag = SELECTED_BUTTON_IMAGE_TAG;
                buttonSelectedImageView.Hidden = true;
                selectionButton.AddSubview (buttonSelectedImageView);

                UIImageView buttonNotSelectedImageView = new UIImageView (UIImage.FromBundle ("modal-checkbox"));
                buttonNotSelectedImageView.Frame = new RectangleF (30, 18, buttonNotSelectedImageView.Frame.Width, buttonNotSelectedImageView.Frame.Height);
                buttonNotSelectedImageView.Tag = NOT_SELECTED_BUTTON_IMAGE_TAG;
                buttonNotSelectedImageView.Hidden = false;
                selectionButton.AddSubview (buttonNotSelectedImageView);

                UILabel buttonLabel = new UILabel (new RectangleF (buttonSelectedImageView.Frame.Right + 34, buttonSelectedImageView.Frame.Y, 210, 20));
                buttonLabel.TextColor = UIColor.White;
                buttonLabel.Font = A.Font_AvenirNextMedium14;
                buttonLabel.Text = label;
                selectionButton.AddSubview (buttonLabel);

                return selectionButton;
            }
        }

        protected void CreateLabelList ()
        {
            phoneLabels.Add (new PhoneLabel (Xml.Contacts.HomePhoneNumber, "Home"));
            phoneLabels.Add (new PhoneLabel (Xml.Contacts.MobilePhoneNumber, "Mobile"));
            phoneLabels.Add (new PhoneLabel (Xml.Contacts.BusinessPhoneNumber, "Work"));
            phoneLabels.Add (new PhoneLabel (Xml.Contacts.CarPhoneNumber, "Car"));
            phoneLabels.Add (new PhoneLabel (Xml.Contacts.AssistantPhoneNumber, "Assistant"));
            phoneLabels.Add (new PhoneLabel (Xml.Contacts.RadioPhoneNumber, "Radio"));
            phoneLabels.Add (new PhoneLabel (Xml.Contacts.PagerNumber, "Pager"));
        }

        protected override void Cleanup ()
        {
            DismissButton.Clicked -= DismissViewTouchUpInside;
            DismissButton = null;

            for (int i = 0; i < View.Subviews.Length; i++) {
                if (View.Subviews [i].GetType () == typeof(UIButton)) {
                    if (View.Subviews [i].Tag >= SELECTION_BUTTON_STARTING_TAG) {
                        UIButton selectionButton = (UIButton)View.Subviews [i];
                        selectionButton.TouchUpInside -= SelectionButtonClicked;
                        selectionButton = null;
                    }
                }
            }
        }

        protected override void ConfigureAndLayout ()
        {

        }

        public void SetContact (McContact contact)
        {
            this.contact = contact;
        }

        private void DismissViewTouchUpInside (object sender, EventArgs e)
        {
            owner.phoneLabel = selectedPhoneLabel;
            owner.SetPhoneLabel ();
            DismissViewController (true, null);
        }
    }
}
