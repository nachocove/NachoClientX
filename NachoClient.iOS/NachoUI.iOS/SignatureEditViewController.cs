// This file has been autogenerated from a class added in the UI designer.

using System;
using CoreGraphics;
using Foundation;
using UIKit;

namespace NachoClient.iOS
{
    public partial class SignatureEditViewController : NcUIViewControllerNoLeaks
    {
        public SignatureEditViewController (IntPtr handle)
            : base (handle)
        {
        }

        public delegate void OnSaveCallback (string text);

        string itemTitle;
        string explanatoryText;
        string existingText;
        public OnSaveCallback OnSave;

        UILabel labelView;
        NcTextView textView;
        UIBarButtonItem saveButton;
        UIBarButtonItem cancelButton;

        private static nfloat HORIZONTAL_MARGIN = 15f;
        private static nfloat VERTICAL_MARGIN = 15f;

        public void Setup (string title, string explanatoryText, string existingText)
        {
            this.itemTitle = title;
            this.explanatoryText = explanatoryText;
            this.existingText = existingText;
        }

        protected override void CreateViewHierarchy ()
        {
            cancelButton = new NcUIBarButtonItem ();
            Util.SetAutomaticImageForButton (cancelButton, "icn-close");
            cancelButton.AccessibilityLabel = "Close";
            cancelButton.Clicked += CancelButton_Clicked;

            saveButton = new NcUIBarButtonItem ();
            saveButton.Title = "Save";
            saveButton.AccessibilityLabel = "Send";
            saveButton.Clicked += SaveButton_Clicked;

            NavigationItem.LeftBarButtonItem = cancelButton;
            NavigationItem.RightBarButtonItem = saveButton;

            labelView = new UILabel (new CGRect (0, 0, View.Frame.Width, 0));
            labelView.Font = A.Font_AvenirNextRegular14;
            labelView.TextColor = UIColor.Black;
            labelView.TextAlignment = UITextAlignment.Center;
            labelView.BackgroundColor = A.Color_NachoLightGrayBackground;
            labelView.LineBreakMode = UILineBreakMode.WordWrap;
            View.AddSubview (labelView);

            textView = new NcTextView (new CGRect (HORIZONTAL_MARGIN, 0, View.Frame.Width - (2 * HORIZONTAL_MARGIN), View.Frame.Height));
            textView.Font = A.Font_AvenirNextRegular14;
            textView.TextColor = A.Color_NachoBlack;
            textView.BackgroundColor = UIColor.White;
            textView.ContentInset = new UIEdgeInsets (VERTICAL_MARGIN, 0, VERTICAL_MARGIN, 0);
            textView.SelectionChanged += SelectionChangedHandler;
            View.AddSubview (textView);
        }

        void SaveButton_Clicked (object sender, EventArgs e)
        {
            if (null != OnSave) {
                OnSave (textView.Text);
            }
            NavigationController.PopViewController (true);
        }

        void CancelButton_Clicked (object sender, EventArgs e)
        {
            View.EndEditing (true);
            NavigationController.PopViewController (true);
        }

        protected override void ConfigureAndLayout ()
        {
            if (null == explanatoryText) {
                labelView.Hidden = true;
                ViewFramer.Create (labelView).Height (0);
            } else {
                labelView.Hidden = false;
                labelView.Lines = 0;
                labelView.Text = explanatoryText;
                labelView.SizeToFit ();
                ViewFramer.Create (labelView).AdjustHeight (20).Width (View.Frame.Width);
            }

            textView.Text = existingText;
            textView.SelectedRange = new NSRange (0, 0);
            textView.BecomeFirstResponder ();

            Layout ();
        }

        protected override void Cleanup ()
        {
            textView.SelectionChanged -= SelectionChangedHandler;
            textView = null;
        }

        protected override void OnKeyboardChanged ()
        {
            Layout ();
            MakeCaretVisible (false);
        }

        private void Layout ()
        {
            var yOffset = labelView.Frame.Bottom;
            ViewFramer.Create (textView).Y(yOffset).Height (View.Frame.Height - yOffset - keyboardHeight);
        }

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();
            NavigationItem.Title = itemTitle;
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            if (null != this.NavigationController) {
                this.NavigationController.ToolbarHidden = true;
            }
        }

        public override void ViewDidAppear (bool animated)
        {
            base.ViewDidAppear (animated);
            if (this.NavigationController.RespondsToSelector (new ObjCRuntime.Selector ("interactivePopGestureRecognizer"))) {
                this.NavigationController.InteractivePopGestureRecognizer.Enabled = false;
                this.NavigationController.InteractivePopGestureRecognizer.Delegate = null;
            }
        }

        public override bool HidesBottomBarWhenPushed {
            get {
                return this.NavigationController.TopViewController == this;
            }
        }

        private void MakeCaretVisible (bool animated)
        {
            var caretFrame = textView.GetCaretRectForPosition (textView.SelectedTextRange.End);
            textView.ScrollRectToVisible (caretFrame, animated);
        }

        private void SelectionChangedHandler (object sender, EventArgs args)
        {
            MakeCaretVisible (true);
        }
    }
}
