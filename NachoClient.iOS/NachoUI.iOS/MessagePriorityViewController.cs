// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using NachoCore.Model;
using NachoCore.Utils;
using NachoCore.Brain;
using MonoTouch.CoreAnimation;
using System.Drawing;

namespace NachoClient.iOS
{
    public partial class MessagePriorityViewController : BlurryViewController, INachoMessageEditor
    {
        public McEmailMessageThread thread;
        protected INachoMessageEditorParent owner;


        public enum DatePickerActionType
        {
            None,
            Defer,
            Deadline,
        };

        DatePickerActionType datePickerAction = DatePickerActionType.None;

        public MessagePriorityViewController (IntPtr handle) : base (handle)
        {
        }

        public void SetOwner (INachoMessageEditorParent o)
        {
            owner = o;
        }

        public void DismissMessageEditor (bool animated, NSAction action)
        {
            owner = null;
            DismissViewController (animated, action);
        }

        public override void ViewDidLoad ()
        {
            INachoMessageEditorParent own = owner;
            base.ViewDidLoad ();
            owner = own;

            float frameHeight = 420;
            float frameWidth = 280;

            PriorityView priorityView = new PriorityView (new RectangleF (20, 70, frameWidth, frameHeight));
            priorityView.SetOwner (this);
            priorityView.initButtonManager ();
            priorityView.MakeButtonLabels ();
            priorityView.Layer.CornerRadius = 15.0f;
            priorityView.ClipsToBounds = true;
            priorityView.BackgroundColor = UIColor.White;
            priorityView.AddEscapeButton ();
            priorityView.AddEscapeButton ();
            priorityView.AddDeferMessageLabel ();
            priorityView.MakeActionButtons ();
            View.AddSubview (priorityView);
        }

        /// Touch anywhere else, and we'll close this view
        public override void TouchesBegan (NSSet touches, UIEvent evt)
        {
            owner.DismissChildMessageEditor (this);
        }

        public override void PrepareForSegue (UIStoryboardSegue segue, NSObject sender)
        {
            var blurry = segue.DestinationViewController as BlurryViewController;
            if (null != blurry) {
                blurry.CaptureView (this.View);
            }

            if (segue.Identifier == "MessagePriorityToDatePicker") {
                var vc = (DatePickerViewController)segue.DestinationViewController;
                vc.owner = this;
            }
        }
        // TODO: Do we need to worry about local vs. utc time?
        public void DismissDatePicker (DatePickerViewController vc, DateTime chosenDateTime)
        {
            if (DateTime.UtcNow > chosenDateTime) {
                // TODO -- Confirm that the user wants to go back in time.
                return;
            } 
            switch (datePickerAction) {
            case DatePickerActionType.Defer:
                NcMessageDeferral.DeferThread (thread, MessageDeferralType.Custom, chosenDateTime);
                break;
            case DatePickerActionType.Deadline:
                NcMessageDeferral.SetDueDate (thread, chosenDateTime);
                break;
            }
            vc.owner = null;
            vc.DismissViewController (false, new NSAction (delegate {
                owner.DismissChildMessageEditor (this);
            }));
        }

        public void DelayRequest (string request)
        {
            DateTime now = DateTime.Now;

            switch (request) {
            case "Later":
            case "Tonight":
            case "Tomorrow":
            case "NextWeek":
            case "MonthEnd":
            case "NextMonth":
            case "Forever":
                NcMessageDeferral.DeferThread (thread, MessageDeferralType.Forever);
                owner.DismissChildMessageEditor (this);
                return;
            case "Custom":
                datePickerAction = DatePickerActionType.Defer;
                PerformSegue ("MessagePriorityToDatePicker", this);
                break;
            case "None":
            default:
                NcAssert.CaseError ();
                return;
            }
        }

        public void CreateMeeting ()
        {
            owner.CreateMeetingEmailForMessage (this, thread);
        }

        public void CreateTask ()
        {
            owner.CreateTaskForEmailMessage (this, thread);
        }

        public void CreateDeadline ()
        {
            datePickerAction = DatePickerActionType.Deadline;
            PerformSegue ("MessagePriorityToDatePicker", this);
        }
    }
}
