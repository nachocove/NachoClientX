// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using NachoCore.Model;
using NachoCore.Utils;
using NachoCore.Brain;
using MonoTouch.CoreAnimation;
using System.Drawing;

namespace NachoClient.iOS
{
    public partial class MessagePriorityViewController : BlurryViewController, INcDatePickerDelegate, INachoDateController
    {
        public McEmailMessageThread thread;
        protected INachoDateControllerParent owner;
        protected IntentSelectionViewController intentSelector;
        protected DateControllerType dateControllerType = DateControllerType.Defer;

        const float BUTTON_SIZE = 64;
        const float BUTTON_LABEL_HEIGHT = 40;
        const float BUTTON_PADDING_HEIGHT = 15;
        const float BUTTON_PADDING_WIDTH = 35;

        private List<UIButton> ActionButtons = new List<UIButton> ();

        public MessagePriorityViewController (IntPtr handle) : base (handle)
        {
        }

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();
            CreateView ();
        }

        public void SetDateControllerType (DateControllerType type)
        {
            this.dateControllerType = type;
        }

        public void SetIntentSelector (IntentSelectionViewController selector)
        {
            this.intentSelector = selector;
        }

        public void CreateView ()
        {
            UIView priorityView = new UIView (View.Frame);
            priorityView.ClipsToBounds = true;
            priorityView.BackgroundColor = A.Color_NachoGreen;

            float yOffset = 40;

            UIButton dismissButton = new UIButton (new RectangleF (30, yOffset, 25, 25));
            dismissButton.SetImage(UIImage.FromBundle("modal-close"), UIControlState.Normal);
            dismissButton.TouchUpInside += (object sender, EventArgs e) => {
                DismissViewController (true, null);
            };
            priorityView.Add (dismissButton);

            UILabel viewTitle = new UILabel (new RectangleF (priorityView.Frame.Width / 2 - 75, yOffset, 150, 25));
            if (DateControllerType.Defer == dateControllerType) {
                viewTitle.Text = "Defer Message";
            } else {
                viewTitle.Text = "Pick A Date";
            }
            viewTitle.Font = A.Font_AvenirNextDemiBold17;
            viewTitle.TextColor = UIColor.White;
            viewTitle.TextAlignment = UITextAlignment.Center;
            priorityView.Add (viewTitle);

            yOffset = viewTitle.Frame.Bottom + 20;

            UIView sectionSeparator = new UIView (new RectangleF(0, yOffset, View.Frame.Width, .5f));
            sectionSeparator.BackgroundColor = UIColor.LightGray.ColorWithAlpha(.6f);
            priorityView.AddSubview (sectionSeparator);

            yOffset = sectionSeparator.Frame.Bottom + 20;

            if (DateControllerType.Defer == dateControllerType) {
                UILabel messageSubject = new UILabel (new RectangleF (30, yOffset, View.Frame.Width - 60, 25));
                messageSubject.Text = thread.GetEmailMessage(0).Subject;
                messageSubject.Font = A.Font_AvenirNextRegular17;
                messageSubject.TextColor = UIColor.White;
                priorityView.Add (messageSubject);

                yOffset = messageSubject.Frame.Bottom + 60;
            } else {
                yOffset += 40;
            }

            var buttonInfoList = new List<ButtonInfo> (new ButtonInfo[] {
                new ButtonInfo ("Later Today", "modal-later-today", () => DateSelected(MessageDeferralType.Later, DateTime.MinValue)),
                new ButtonInfo ("Tonight", "modal-tonight", () => DateSelected(MessageDeferralType.Tonight, DateTime.MinValue)),
                new ButtonInfo ("Tomorrow", "modal-tomorrow", () => DateSelected(MessageDeferralType.Tomorrow, DateTime.MinValue)),
                new ButtonInfo (null, null, null),
                new ButtonInfo ("This Week", "modal-this-week", () => DateSelected(MessageDeferralType.NextWeek, DateTime.MinValue)),
                new ButtonInfo ("Next Week", "modal-next-week", () => DateSelected(MessageDeferralType.NextWeek, DateTime.MinValue)),
                new ButtonInfo ("Pick Date", "modal-pick-date", () =>  PerformSegue ("MessagePriorityToDatePicker", this)),
                new ButtonInfo (null, null, null),
                new ButtonInfo ("Forever", "modal-forever", () => DateSelected(MessageDeferralType.Forever, DateTime.MinValue)),
                new ButtonInfo ("None", "modal-none", () => DateSelected(MessageDeferralType.None, DateTime.MinValue)),
                null,
            });

            var center = priorityView.Center;
            center.X = (priorityView.Frame.Width / 2);
            center.Y = center.Y;

            var xOffset = center.X - BUTTON_SIZE - BUTTON_PADDING_WIDTH;

            foreach (var buttonInfo in buttonInfoList) {
                if (null == buttonInfo) {
                    xOffset += BUTTON_SIZE + BUTTON_PADDING_WIDTH;
                    continue;
                }
                if (null == buttonInfo.buttonLabel) {
                    xOffset = center.X - BUTTON_SIZE - BUTTON_PADDING_WIDTH;
                    yOffset += BUTTON_SIZE + BUTTON_LABEL_HEIGHT + BUTTON_PADDING_HEIGHT;
                    continue;
                }

                var buttonRect = UIButton.FromType (UIButtonType.RoundedRect);
                buttonRect.Layer.CornerRadius = BUTTON_SIZE / 2;
                buttonRect.Layer.MasksToBounds = true;
                buttonRect.Layer.BorderColor = UIColor.LightGray.CGColor;
                buttonRect.Layer.BorderWidth = .5f;                 
                buttonRect.Frame = new RectangleF (0, 0, BUTTON_SIZE, BUTTON_SIZE);
                buttonRect.Center = new PointF (xOffset, yOffset);
                buttonRect.SetImage (UIImage.FromBundle (buttonInfo.buttonIcon), UIControlState.Normal);
                buttonRect.TouchUpInside += (object sender, EventArgs e) => {
                    buttonInfo.buttonAction ();
                };
                ActionButtons.Add (buttonRect);
                priorityView.Add (buttonRect);

                var label = new UILabel ();
                label.TextColor = UIColor.White;
                label.Text = buttonInfo.buttonLabel;
                label.Font = A.Font_AvenirNextMedium14;
                label.TextAlignment = UITextAlignment.Center;
                label.SizeToFit ();
                label.Center = new PointF (xOffset, 5 + yOffset + ((BUTTON_SIZE + BUTTON_LABEL_HEIGHT) / 2));
                priorityView.Add (label);

                xOffset += BUTTON_SIZE + BUTTON_PADDING_WIDTH;
            }

            View.AddSubview (priorityView);
        }

        public void SetOwner (INachoDateControllerParent o)
        {
            owner = o;
        }


        public void DimissDateController (bool animated, NSAction action)
        {
            owner = null;
            DismissViewController (animated, action);
        }

        public override void PrepareForSegue (UIStoryboardSegue segue, NSObject sender)
        {
            var blurry = segue.DestinationViewController as BlurryViewController;
            if (null != blurry) {
                blurry.CaptureView (this.View);
            }

            if (segue.Identifier == "MessagePriorityToDatePicker") {
                var vc = (DatePickerViewController)segue.DestinationViewController;
                vc.owner = this;
            }
        }
        // TODO: Do we need to worry about local vs. utc time?
        public void DismissDatePicker (DatePickerViewController vc, DateTime chosenDateTime)
        {
            if (DateTime.UtcNow > chosenDateTime) {
                // TODO -- Confirm that the user wants to go back in time.
                return;
            } 

            DateSelected (MessageDeferralType.Custom, chosenDateTime);

            vc.owner = null;
            vc.DismissViewController (false, new NSAction (delegate {
                owner.DismissChildDateController (this);
                if (null != intentSelector) {
                    intentSelector.DismissIntentChooser (false, null);
                }
            }));
        }

        public void DateSelected (MessageDeferralType dateType, DateTime selectedDate)
        {
            if (MessageDeferralType.Custom == dateType) {
                owner.DateSelected (dateType, thread, selectedDate);
            } else {
                switch (dateType) {
                case MessageDeferralType.Later:
                    selectedDate = DateTime.Today;
                    break;
                case MessageDeferralType.Tonight:
                    selectedDate = DateTime.Today.AddHours(23);
                    break;
                case MessageDeferralType.Tomorrow:
                    selectedDate = DateTime.Today.AddDays (1);
                    break;
                case MessageDeferralType.NextWeek:
                    selectedDate = DateTime.Today.AddDays (8 - (int)DateTime.Today.DayOfWeek);
                    break;
                case MessageDeferralType.NextMonth:
                    selectedDate = new DateTime (DateTime.Today.AddMonths (1).Year, DateTime.Today.AddMonths (1).Month, 1);
                    break;
                default:
                    break;
                }
                owner.DateSelected (dateType, thread, selectedDate);
                owner.DismissChildDateController (this);

                if (null != intentSelector) {
                    intentSelector.DismissIntentChooser (false, null);
                }
            }
        }

        protected class ButtonInfo
        {
            public string buttonLabel { get; set; }

            public string buttonIcon { get; set; }

            public Action buttonAction { get; set; }

            public ButtonInfo (string bl, string bi, Action ba)
            {
                buttonLabel = bl;
                buttonIcon = bi;
                buttonAction = ba;
            }
        }
    }
}
