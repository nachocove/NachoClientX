// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Drawing;
using System.Linq;
using System.Collections.Generic;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using MonoTouch.Dialog;
using NachoCore.Model;
using NachoCore.Utils;
using NachoCore;
using MimeKit;

namespace NachoClient.iOS
{
    public partial class ComposeViewController : DialogViewController, INachoMessageController, INachoContactChooserDelegate
    {
        protected class MyEmailAddress : NcEmailAddress
        {
            public enum Action
            {
                undefined,
                create,
                edit,
            };

            public Action action;
            public int index;

            public MyEmailAddress (Kind kind) : base (kind)
            {
                this.action = Action.undefined;
            }

            public MyEmailAddress (Kind kind, string action) : base (kind, action)
            {
                this.action = Action.undefined;
            }
        }

        string Subject;
        MultilineEntryElement Body;
        List<MyEmailAddress> AddressList = new List<MyEmailAddress> ();
        public static readonly NSString Reply = new NSString ("Reply");
        public static readonly NSString ReplyAll = new NSString ("ReplyAll");
        public static readonly NSString Forward = new NSString ("Forward");
        public string Action;
        public List<McEmailMessage> ActionThread;
        public INachoMessageControllerDelegate owner;

        public ComposeViewController (IntPtr handle) : base (handle)
        {
    
        }

        public void SetOwner (INachoMessageControllerDelegate o)
        {
            owner = o;
        }

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();

            Style = UITableViewStyle.Plain;
            TableView.SeparatorInset = new UIEdgeInsets (0, 0, 0, 0);

            // Closes the multi-line edit view!
            var tap = new UITapGestureRecognizer ();
            tap.AddTarget (() => {
                this.View.EndEditing (true);
            });
            tap.CancelsTouchesInView = false;
            this.View.AddGestureRecognizer (tap);

            SendButton.Clicked += (object sender, EventArgs e) => {
                SendMessage ();
            };

            if (null != ActionThread) {
                InitializeMessageForAction ();
            }

            Pushing = true;
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            ReloadRoot ();
        }

        public override void PrepareForSegue (UIStoryboardSegue segue, NSObject sender)
        {
            if (segue.Identifier.Equals ("ComposeToContactChooser")) {
                var dc = (INachoContactChooser)segue.DestinationViewController;
                var holder = sender as SegueHolder;
                var address = (MyEmailAddress)holder.value;
                dc.SetOwner (this, address, NachoContactType.EmailRequired);
            }
        }

        public void DismissINachoContactChooser (INachoContactChooser vc)
        {
            NachoAssert.CaseError ();
        }

        Section toAddresses;
        Section ccAddresses;
        Section bccAddresses;

        protected void ReloadRoot ()
        {
            var root = new RootElement ("New Message");

            ReloadAddresses ();

            root.Add (toAddresses);
            root.Add (ccAddresses);
            root.Add (bccAddresses);

            var section = new Section ();
            root.Add (section);

            var subjectEntry = new EntryElement ("Subject: ", "", Subject);
            subjectEntry.Changed += delegate(object sender, EventArgs e) {
                EntryElement o = (EntryElement)sender;
                Subject = o.Value;
            };
            section.Add (subjectEntry);

            var s = (null == Body) ? null : Body.Summary ();
            Body = new MultilineEntryElement ("Enter your message...", s, 120.0f, true);
            section.Add (Body);

            root.UnevenRows = true;
            Root = root;
        }

        protected void ReloadAddresses ()
        {
            toAddresses = CustomSection (NcEmailAddress.Kind.To);
            ccAddresses = CustomSection (NcEmailAddress.Kind.Cc);
            bccAddresses = CustomSection (NcEmailAddress.Kind.Bcc);

            for (int i = 0; i < AddressList.Count; i++) {
                var a = AddressList [i];
                var e = new StringElement (a.address);
                var lambda_object = i;
                e.Tapped += () => {
                    AddressTapped (lambda_object);
                };
                switch (a.kind) {
                case NcEmailAddress.Kind.To:
                    toAddresses.Add (e);
                    break;
                case NcEmailAddress.Kind.Cc:
                    ccAddresses.Add (e);
                    break;
                case NcEmailAddress.Kind.Bcc:
                    bccAddresses.Add (e);
                    break;
                default:
                    NachoAssert.CaseError ();
                    break;
                }
            }
        }

        /// <summary>
        /// Create a section for To, CC, and Bcc
        /// with special cell to trigger a new address.
        /// </summary>
        public Section CustomSection (NcEmailAddress.Kind kind)
        {
            var e = new StyledStringElement (NcEmailAddress.ToPrefix (kind));
            e.Image = UIImage.FromBundle ("ic_action_add_person");
            e.TextColor = UIColor.LightGray;
            e.BackgroundColor = UIColor.LightTextColor;
            e.Tapped += () => {
                SectionTapped (kind);
            };
            var s = new Section ();
            s.HeaderView = new UIView (new RectangleF (0.0f, 0.0f, 1.0f, 1.0f));
            s.FooterView = new UIView (new RectangleF (0.0f, 0.0f, 1.0f, 1.0f));
            s.Add (e);
            return s;
        }

        protected void AddressTapped (int i)
        {
            var address = AddressList [i];
            address.index = i;
            address.action = MyEmailAddress.Action.edit;
            PerformSegue ("ComposeToContactChooser", new SegueHolder (address));
        }

        protected void SectionTapped (NcEmailAddress.Kind kind)
        {
            var address = new MyEmailAddress (kind);
            address.action = MyEmailAddress.Action.create;
            PerformSegue ("ComposeToContactChooser", new SegueHolder (address));
        }

        public void UpdateEmailAddress (NcEmailAddress address)
        {
            var a = address as MyEmailAddress;
            NachoAssert.True (null != a);

            switch (a.action) {
            case MyEmailAddress.Action.edit:
                AddressList [a.index] = a;
                break;
            case MyEmailAddress.Action.create:
                AddressList.Add (a);
                break;
            default:
                NachoAssert.CaseError ();
                break;
            }
        }

        public void DeleteEmailAddress (NcEmailAddress address)
        {
            var a = address as MyEmailAddress;
            NachoAssert.True (null != a);

            if (MyEmailAddress.Action.edit == a.action) {
                AddressList.RemoveAt (a.index);
            }
        }

        public MailboxAddress GetMailboxAddress (NcEmailAddress address)
        {
            // Must have a contact or an address
            NachoAssert.True ((null != address.contact) || (null != address.address));

            string candidate;
            MailboxAddress mailbox;

            if (null != address.contact) {
                candidate = address.contact.DisplayEmailAddress;
            } else {
                candidate = address.address;
            }

            if (!MailboxAddress.TryParse (candidate, out mailbox)) {
                Log.Error ("Mailbox candidate won't parse: {0}", candidate);
                return null;
            }

            if (null == mailbox.Address) {
                Log.Error ("Mailbox candidate has null address: {0}", candidate);
                return null;
            }

            if (null == mailbox.Name) {
                mailbox.Name = address.contact.DisplayName;
            }

            return mailbox;
        }

        /// <summary>
        /// Backend is converting to mime.
        /// TODO: SendMessage should encode as mime or not.
        /// </summary>
        public void SendMessage ()
        {
            var mimeMessage = new MimeMessage ();

            foreach (var a in AddressList) {
                var mailbox = GetMailboxAddress (a);
                if (null == mailbox) {
                    continue;
                }
                switch (a.kind) {
                case NcEmailAddress.Kind.To:
                    mimeMessage.To.Add (mailbox);
                    break;
                case NcEmailAddress.Kind.Cc:
                    mimeMessage.Cc.Add (mailbox);
                    break;
                case NcEmailAddress.Kind.Bcc:
                    mimeMessage.Bcc.Add (mailbox);
                    break;
                default:
                    NachoAssert.CaseError ();
                    break;
                }
            }
            if (null != Subject) {
                mimeMessage.Subject = Subject;
            }
            mimeMessage.Date = System.DateTime.UtcNow;
           
            var body = new TextPart ("plain");
            var text = Body.Summary ();
            if (null != text) {
                body.Text = text;
            }
            mimeMessage.Body = body;

            // TODO: Push account in UI
            // We only have one account, for now.
            var account = BackEnd.Instance.Db.Table<McAccount> ().First ();

            MimeHelpers.SendEmail (account.Id, mimeMessage);

            // Might want to defer until BE says message is queued.
            owner = null;
            NavigationController.PopViewControllerAnimated (true);
        }

        /// <summary>
        /// Reply, ReplyAll, Forward
        /// </summary>
        void InitializeMessageForAction ()
        {
            var ActionMessage = ActionThread.First ();

            if (Action.Equals (Reply) || Action.Equals (ReplyAll)) {
                Subject = "Re: " + ActionMessage.Subject;
                AddressList.Add (new MyEmailAddress (NcEmailAddress.Kind.To, ActionMessage.From));
            }
            if (Action.Equals (Forward)) {
                Subject = "Fwd: " + ActionMessage.Subject;
            }
            if (Action.Equals (ReplyAll)) {
                // Add the To list to the CC list
                if (null != ActionMessage.To) {
                    string[] ToList = ActionMessage.To.Split (new Char [] { ',' });
                    if (null != ToList) {
                        foreach (var a in ToList) {
                            AddressList.Add (new MyEmailAddress (NcEmailAddress.Kind.Cc, a));
                        }
                    }
                }
                // And keep the existing CC list
                if (null != ActionMessage.Cc) {
                    string[] ccList = ActionMessage.Cc.Split (new Char [] { ',' });
                    if (null != ccList) {
                        foreach (var a in ccList) {
                            AddressList.Add (new MyEmailAddress (NcEmailAddress.Kind.Cc, a));
                        }
                    }
                }
            }
            // TODO: Setup message id, etc etc.
            // Handle body
            var body = ActionMessage.GetBody ();
            if (null == body) {
                return;
            }
            if (Action.Equals (Forward)) {
                // TODO: Compose needs to be smart about MIME messages.
                Body = new MultilineEntryElement ("Enter your message...", null, 120.0f, true);
                return;
            }
            string someText = MimeHelpers.FetchSomeText (body);
            string quotedText = QuoteForReply (someText);
            Body = new MultilineEntryElement ("Enter your message...", quotedText, 120.0f, true);
        }

        string QuoteForReply (string s)
        {
            if (null == s) {
                return s;
            }
            string[] lines = s.Split (new Char[] { '\n' });
            string quotes = "\n> " + String.Join ("\n> ", lines);
            return quotes;
        }
    }
}
