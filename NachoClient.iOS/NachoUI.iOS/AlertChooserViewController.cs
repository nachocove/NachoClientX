// This file has been autogenerated from a class added in the UI designer.

using System;

using MonoTouch.Foundation;
using MonoTouch.UIKit;

using System.IO;
using System.Linq;
using System.Drawing;
using System.Collections.Generic;

using NachoCore.Utils;

namespace NachoClient.iOS
{
    public partial class AlertChooserViewController : NcUIViewControllerNoLeaks
    {
        UITableView tableView;
        AlertChoicesSource source;

        uint reminder;
        bool reminderIsSet;

        public AlertChooserViewController (IntPtr handle) : base (handle)
        {
        }

        public override void ViewDidLoad ()
        {
            base.ViewDidLoad ();
        }

        protected override void CreateViewHierarchy ()
        {
            tableView = new UITableView (View.Frame, UITableViewStyle.Plain);
            tableView.ScrollEnabled = false;
            source = new AlertChoicesSource (this);
            tableView.Source = source;

            View.Add (tableView);

            NavigationItem.Title = "Reminder";
            Util.SetBackButton (NavigationController, NavigationItem, A.Color_NachoBlue);
        }

        public override void ViewWillAppear (bool animated)
        {
            base.ViewWillAppear (animated);
            var index = source.IndexOfSelection ();
            tableView.SelectRow (NSIndexPath.FromRowSection (index, 0), false, UITableViewScrollPosition.None);
        }

        protected override void ConfigureAndLayout ()
        {
        }

        protected override void Cleanup ()
        {
            tableView.Source = null;
            tableView.Dispose ();
            tableView = null;
            source = null;
        }

        public override bool HidesBottomBarWhenPushed {
            get {
                return this.NavigationController.TopViewController == this;
            }
        }

        public void SetReminder (bool reminderIsSet, uint reminder)
        {
            this.reminder = reminder;
            this.reminderIsSet = reminderIsSet;
        }

        public bool GetReminder (out uint reminder)
        {
            if (reminderIsSet) {
                reminder = this.reminder;
                return true;
            }
            reminder = 0;
            return false;
        }

        public void Done ()
        {
            NavigationController.PopViewControllerAnimated (true);
        }

        protected class AlertChoicesSource : UITableViewSource
        {
            AlertChooserViewController owner;

            List<uint> choices = new List<uint> (new uint[] { 0, 0, 1, 5, 15, 30, 60, 1440, 2880, 10080 });

            public AlertChoicesSource (AlertChooserViewController owner)
            {
                this.owner = owner;
                // Add the reminder if it's not in our list
                if(!choices.Contains(owner.reminder)) {
                    choices.Add(owner.reminder);
                    choices.Sort();
                }
            }

            public int IndexOfSelection()
            {
                NcAssert.NotNull (owner);

                if (!owner.reminderIsSet) {
                    return 0;
                }
                for (var i = 0; i < choices.Count; i++) {
                    if (owner.reminder == choices [i]) {
                        return i;
                    }
                }
                NcAssert.CaseError ();
                return 0;
            }

            public override int RowsInSection (UITableView tableview, int section)
            {
                return choices.Count;
            }

            public override UITableViewCell GetCell (UITableView tableView, NSIndexPath indexPath)
            {
                const string cellId = "Choice";

                var cell = tableView.DequeueReusableCell (cellId);
                if (null == cell) {
                    cell = new UITableViewCell (UITableViewCellStyle.Default, cellId);
                    using (var image = UIImage.FromBundle ("gen-checkbox")) {
                        cell.ImageView.Image = image;
                    }
                    using (var highlightedImage = UIImage.FromBundle ("gen-checkbox-checked")) {
                        cell.ImageView.HighlightedImage = highlightedImage;
                    }
                    cell.TextLabel.TextColor = UIColor.Black;
                    cell.SelectionStyle = UITableViewCellSelectionStyle.Default;
                }
                cell.TextLabel.Text = Pretty.ReminderString (0 != indexPath.Row, choices [indexPath.Row]);
                return cell;
            }

            public override void RowSelected (UITableView tableView, NSIndexPath indexPath)
            {
                if (null != owner) {
                    owner.SetReminder (0 != indexPath.Row, choices [indexPath.Row]);
                    owner.Done ();
                }
            }
        }
    }
}
